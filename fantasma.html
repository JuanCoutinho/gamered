<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fantasma de Esparta: God Slayer</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');

        body {
            margin: 0; overflow: hidden; background-color: #050505;
            font-family: 'Cinzel', serif; color: white; user-select: none; touch-action: none;
        }
        #gameCanvas { display: block; cursor: crosshair; }

        /* UI Overlay */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; z-index: 10;
        }

        .top-bar {
            display: grid; grid-template-columns: 1fr auto 1fr; width: 100%; align-items: start;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .stats-panel { display: flex; flex-direction: column; gap: 8px; }
        
        /* Health Bar com efeito de sangue */
        .bar-frame {
            width: 320px; height: 28px; background: #1a0a0a; border: 2px solid #a67c00;
            transform: skewX(-15deg); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            position: relative;
        }
        .hp-fill { 
            height: 100%; background: linear-gradient(180deg, #e74c3c, #c0392b 50%, #922b21); 
            width: 100%; transition: width 0.1s; box-shadow: inset 0 2px 5px rgba(255,255,255,0.3);
        }
        .xp-frame {
            width: 280px; height: 8px; background: #000; border: 1px solid #555;
            transform: skewX(-15deg); margin-left: 10px;
        }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); width: 0%; transition: width 0.2s; }

        .center-panel { text-align: center; }
        .timer { font-size: 36px; font-weight: 900; color: #ecf0f1; letter-spacing: 3px; }
        
        .right-panel { text-align: right; }
        .artifact-count { font-size: 22px; color: #f1c40f; font-weight: bold; }

        /* Boss HUD Epic */
        #boss-hud {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            width: 60%; display: none; text-align: center; opacity: 0; transition: opacity 0.5s;
        }
        .boss-name { font-size: 32px; color: #e74c3c; font-weight: 900; letter-spacing: 4px; margin-bottom: 5px; text-transform: uppercase; text-shadow: 0 0 20px #000; }
        .boss-hp-frame { width: 100%; height: 20px; background: #222; border: 2px solid #e74c3c; position: relative; box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }
        .boss-hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #641e16, #c0392b, #e74c3c); transition: width 0.1s; }

        /* Combo */
        #combo-container {
            position: absolute; left: 30px; bottom: 180px;
            text-align: left; opacity: 0; transition: transform 0.1s;
        }
        #combo-count { font-size: 64px; font-weight: 900; color: #f1c40f; line-height: 0.8; font-style: italic; text-shadow: 4px 4px 0 #c0392b; }
        #combo-label { font-size: 24px; color: #fff; font-weight: bold; letter-spacing: 2px; margin-left: 5px; }

        /* Mobile */
        #mobile-controls { display: none; position: absolute; bottom: 20px; left: 0; width: 100%; height: 150px; pointer-events: none; }
        .joy-zone { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); pointer-events: auto; }
        .joy-stick { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; background: rgba(255,255,255,0.3); border-radius: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 10px rgba(255,255,255,0.2); pointer-events: none; }
        .btn-zone { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 20px; align-items: flex-end; pointer-events: auto; }
        .m-btn { border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 28px; border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 5px 15px rgba(0,0,0,0.5); user-select: none; transition: transform 0.1s; }
        .m-btn:active { transform: scale(0.9); }
        .btn-atk { width: 100px; height: 100px; background: linear-gradient(135deg, #c0392b, #922b21); }
        .btn-dash { width: 70px; height: 70px; background: linear-gradient(135deg, #f1c40f, #d35400); margin-bottom: 20px; }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a0a0a 0%, #000000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; pointer-events: auto; text-align: center;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 72px; color: #c0392b; margin: 0; text-shadow: 0 0 40px #f00; letter-spacing: 8px; font-weight: 900; border-bottom: 4px solid #a67c00; padding-bottom: 20px; }
        h2 { color: #f1c40f; margin-bottom: 40px; font-size: 28px; letter-spacing: 4px; text-transform: uppercase; }
        p { color: #bbb; max-width: 600px; font-size: 18px; line-height: 1.6; margin-bottom: 40px; }

        .play-btn {
            padding: 20px 60px; font-family: 'Cinzel', serif; font-size: 28px; font-weight: bold;
            background: linear-gradient(180deg, #333, #111); color: #f1c40f; border: 2px solid #f1c40f;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; position: relative; overflow: hidden;
        }
        .play-btn:hover { background: #f1c40f; color: #000; box-shadow: 0 0 50px rgba(241, 196, 15, 0.4); transform: scale(1.05); }

        /* Cards */
        .cards-wrapper { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; max-width: 1200px; perspective: 1000px; }
        .card {
            width: 220px; height: 320px; background: linear-gradient(160deg, #2c3e50, #000);
            border: 2px solid #777; padding: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: space-between; cursor: pointer; transition: 0.3s;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.8); border-radius: 8px;
        }
        .card:hover { transform: translateY(-20px) rotateX(5deg); border-color: #f1c40f; box-shadow: 0 0 50px rgba(241, 196, 15, 0.3); z-index: 50; }
        .card.legendary { border-color: #f1c40f; background: linear-gradient(160deg, #4a2c2a, #000); }
        .card-icon { font-size: 70px; margin: 20px 0; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .card h3 { color: #fff; font-size: 20px; margin: 0; text-align: center; }
        .card p { font-size: 14px; color: #aaa; text-align: center; margin: 0; }

        #mute-btn { position: absolute; bottom: 20px; left: 20px; background: none; border: none; color: #777; font-size: 30px; cursor: pointer; pointer-events: auto; z-index: 30; opacity: 0.5; transition: 0.2s; }
        #mute-btn:hover { opacity: 1; color: #fff; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="top-bar">
            <div class="stats-panel">
                <div class="bar-frame"><div class="hp-fill" id="hp-bar"></div></div>
                <div class="xp-frame"><div class="xp-fill" id="xp-bar"></div></div>
            </div>
            <div class="center-panel">
                <div class="timer" id="timer">00:00</div>
            </div>
            <div class="right-panel">
                <div class="artifact-count" id="artifact-ui">0/5</div>
            </div>
        </div>

        <div id="boss-hud">
            <div class="boss-name" id="boss-name">BOSS NAME</div>
            <div class="boss-hp-frame"><div class="boss-hp-fill" id="boss-hp"></div></div>
        </div>

        <div id="combo-container">
            <div id="combo-count">0</div>
            <div id="combo-label">HITS</div>
        </div>

        <button id="mute-btn" onclick="toggleMute()">üîä</button>
    </div>

    <div id="mobile-controls">
        <div class="joy-zone" id="joystick"><div class="joy-stick" id="knob"></div></div>
        <div class="btn-zone">
            <div class="m-btn btn-dash" id="btn-dash">‚ö°</div>
            <div class="m-btn btn-atk" id="btn-atk">‚öîÔ∏è</div>
        </div>
    </div>

    <!-- Menus -->
    <div id="menu-screen" class="screen">
        <h1>Fantasma de Esparta</h1>
        <h2>God Slayer</h2>
        <p>O Olimpo caiu. Explore o labirinto eterno, colete os <b>Artefatos Proibidos</b> para for√ßar os Deuses a descerem de seus tronos.<br>Mate 3 Generais para desafiar Ares.</p>
        <button class="play-btn" onclick="Game.start()">Iniciar Vingan√ßa</button>
    </div>

    <div id="upgrade-screen" class="screen hidden">
        <h2>Poder Proibido</h2>
        <p>Escolha seu destino:</p>
        <div class="cards-wrapper" id="upgrade-cards"></div>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #7f8c8d; text-shadow: none; border: none;">Derrotado</h1>
        <p>Sua vingan√ßa termina aqui.</p>
        <button class="play-btn" onclick="location.reload()">Levantar-se</button>
    </div>

    <div id="end-screen" class="screen hidden">
        <h1 style="color: #f1c40f; border-color: #f1c40f;">Vit√≥ria</h1>
        <p>Ares jaz morto aos seus p√©s. O ciclo de vingan√ßa est√° completo.</p>
        <p id="end-time" style="color: #fff; font-size: 24px;">Tempo: 00:00</p>
        <button class="play-btn" onclick="location.reload()">Novo Jogo</button>
    </div>

    <script>
        let gameState = 'MENU';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let WIDTH, HEIGHT;

        const resize = () => { WIDTH = window.innerWidth; HEIGHT = window.innerHeight; canvas.width = WIDTH; canvas.height = HEIGHT; };
        window.addEventListener('resize', resize);
        resize();

        // --- CONFIG & STATE ---
        const Stats = {
            dmg: 35, spd: 6.5, maxHp: 100, crit: 0.05, vamp: 0, 
            reflect: 0, bladeColor: '#e74c3c', range: 170
        };
        const Effects = {
            fire: false, ice: false, lightning: false, necro: false, 
            giant: false, gold: false, shadow: false, multi: false, 
            poison: false, shield: false
        };

        // --- SPRITES ---
        const Sprites = {
            run: new Image(), atk: new Image(), idle: new Image(),
            e_run: new Image(), e_atk: new Image(), e_def: new Image()
        };
        Sprites.run.src = 'https://gamered.vercel.app/kratos.png';
        Sprites.atk.src = 'https://gamered.vercel.app/kratos-attack.png';
        Sprites.idle.src = 'https://gamered.vercel.app/kratos-base.png';
        Sprites.e_run.src = 'https://gamered.vercel.app/enemie.png';
        Sprites.e_atk.src = 'https://gamered.vercel.app/enemie-attack.png';
        Sprites.e_def.src = 'https://gamered.vercel.app/enemie-defense.png';

        // --- CARDS / UPGRADES ---
        const Upgrades = [
            {t:"L√¢minas do Caos", i:"üî•", d:"+Dano e Fogo", f:()=>{Stats.dmg*=1.2; Effects.fire=true; Stats.bladeColor='#ff4500';}},
            {t:"Sand√°lias de Hermes", i:"üëü", d:"+Velocidade Movimento", f:()=>{Stats.spd*=1.2;}},
            {t:"Velocino de Ouro", i:"üõ°Ô∏è", d:"Reflete Dano", f:()=>{Effects.thorns=true; Stats.reflect=0.5;}},
            {t:"Olhar da Medusa", i:"‚ùÑÔ∏è", d:"Chance de Congelar", f:()=>{Effects.ice=true;}},
            {t:"F√∫ria de Zeus", i:"‚ö°", d:"Raios nos Ataques", f:()=>{Effects.lightning=true;}},
            {t:"Cora√ß√£o de Gaia", i:"üíö", d:"+50% Vida M√°xima", f:()=>{Stats.maxHp*=1.5; Game.p.hp+=50;}},
            {t:"Toque de Midas", i:"üí∞", d:"Inimigos viram Ouro (Cura)", f:()=>{Effects.gold=true;}},
            {t:"Necromancia", i:"üíÄ", d:"Explos√µes ao Matar", f:()=>{Effects.necro=true;}},
            {t:"Sangue dos Deuses", i:"ü©∏", d:"Roubo de Vida (Vampirismo)", f:()=>{Stats.vamp+=0.05;}},
            {t:"Tamanho de Tit√£", i:"üóø", d:"Voc√™ fica Gigante (+Alcance)", f:()=>{Effects.giant=true; Stats.range*=1.3;}},
            {t:"Arco de Apolo", i:"üèπ", d:"Dispara proj√©teis ao atacar", f:()=>{Effects.multi=true;}},
            {t:"Sombra de Hades", i:"üåë", d:"Fica invis√≠vel no Dash", f:()=>{Effects.shadow=true;}},
            {t:"Veneno da Hidra", i:"üß™", d:"Dano cont√≠nuo nos inimigos", f:()=>{Effects.poison=true;}},
            {t:"F√∫ria Espartana", i:"üò°", d:"+30% Dano Base", f:()=>{Stats.dmg*=1.3;}},
            {t:"Ben√ß√£o de Atena", i:"ü¶â", d:"Cura Total + XP B√¥nus", f:()=>{Game.p.hp=Stats.maxHp; Game.nxp=Math.floor(Game.nxp*0.8);}}
        ];

        // --- AUDIO SYSTEM 2.0 ---
        const AudioSys = {
            ctx: null, muted: false,
            init() { 
                if(!this.ctx) { window.AudioContext=window.AudioContext||window.webkitAudioContext; this.ctx=new AudioContext(); }
                if(this.ctx.state==='suspended') this.ctx.resume();
            },
            play(type) {
                if(this.muted||!this.ctx) return;
                if(this.ctx.state==='suspended') this.ctx.resume();
                const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);

                if(type==='dash') {
                    o.type='triangle'; o.frequency.setValueAtTime(600, t); o.frequency.exponentialRampToValueAtTime(50, t+0.2);
                    g.gain.setValueAtTime(0.3, t); g.gain.linearRampToValueAtTime(0, t+0.2);
                    o.start(t); o.stop(t+0.2);
                } else if(type==='hit') {
                    o.type='sawtooth'; o.frequency.setValueAtTime(100, t); o.frequency.exponentialRampToValueAtTime(10, t+0.1);
                    g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.1);
                    o.start(t); o.stop(t+0.1);
                } else if(type==='swing') {
                    o.type='triangle'; o.frequency.setValueAtTime(300, t); o.frequency.linearRampToValueAtTime(50, t+0.25);
                    g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.25);
                    o.start(t); o.stop(t+0.25);
                } else if(type==='art') {
                    o.type='sine'; o.frequency.setValueAtTime(800, t); o.frequency.linearRampToValueAtTime(1500, t+0.5);
                    g.gain.setValueAtTime(0.2, t); g.gain.linearRampToValueAtTime(0, t+0.5);
                    o.start(t); o.stop(t+0.5);
                } else if(type==='boss') {
                    o.type='square'; o.frequency.setValueAtTime(60, t); o.frequency.linearRampToValueAtTime(30, t+1.5);
                    g.gain.setValueAtTime(0.4, t); g.gain.linearRampToValueAtTime(0, t+1.5);
                    o.start(t); o.stop(t+1.5);
                }
            }
        };
        function toggleMute(){ AudioSys.muted=!AudioSys.muted; document.getElementById('mute-btn').style.opacity=AudioSys.muted?0.5:1; if(!AudioSys.muted)AudioSys.init(); }

        // --- INPUT & MOBILE ---
        const Input = {
            keys:{w:0,a:0,s:0,d:0,space:0}, mouse:{x:0,y:0,down:0,wx:0,wy:0}, joy:{on:0,dx:0,dy:0}, mobile:0,
            init() {
                window.onkeydown=e=>{if('wasd'.includes(e.key.toLowerCase()))Input.keys[e.key.toLowerCase()]=1;if(e.code==='Space')Input.keys.space=1;};
                window.onkeyup=e=>{if('wasd'.includes(e.key.toLowerCase()))Input.keys[e.key.toLowerCase()]=0;if(e.code==='Space')Input.keys.space=0;};
                window.onmousemove=e=>{const r=canvas.getBoundingClientRect();Input.mouse.x=e.clientX-r.left;Input.mouse.y=e.clientY-r.top;};
                window.onmousedown=()=>{AudioSys.init();Input.mouse.down=1;}; window.onmouseup=()=>{Input.mouse.down=0;};
                document.body.ontouchstart=()=>{Input.mobile=1;AudioSys.init();document.getElementById('mobile-controls').style.display='block';};
                this.joySetup();
            },
            updateWorld(cx,cy){this.mouse.wx=this.mouse.x+cx;this.mouse.wy=this.mouse.y+cy;},
            move(){
                let dx=0,dy=0;
                if(this.joy.on){dx=this.joy.dx;dy=this.joy.dy;}
                else{if(this.keys.w)dy=-1;if(this.keys.s)dy=1;if(this.keys.a)dx=-1;if(this.keys.d)dx=1;}
                const l=Math.hypot(dx,dy); if(l>1||(!this.joy.on&&l>0)){dx/=l;dy/=l;}
                return {x:dx,y:dy};
            },
            joySetup(){
                const j=document.getElementById('joystick'), k=document.getElementById('knob'); let sx,sy;
                j.ontouchstart=e=>{e.preventDefault();sx=e.touches[0].clientX;sy=e.touches[0].clientY;Input.joy.on=1;};
                j.ontouchmove=e=>{e.preventDefault();if(!Input.joy.on)return;const dx=e.touches[0].clientX-sx,dy=e.touches[0].clientY-sy,d=Math.hypot(dx,dy),m=50,c=Math.min(d,m),a=Math.atan2(dy,dx);k.style.transform=`translate(calc(-50% + ${Math.cos(a)*c}px),calc(-50% + ${Math.sin(a)*c}px))`;Input.joy.dx=Math.cos(a)*(c/m);Input.joy.dy=Math.sin(a)*(c/m);};
                const end=()=>{Input.joy.on=0;Input.joy.dx=0;Input.joy.dy=0;k.style.transform='translate(-50%,-50%)';};
                j.ontouchend=end;j.ontouchcancel=end;
                const ba=document.getElementById('btn-atk'), bd=document.getElementById('btn-dash');
                ba.ontouchstart=e=>{e.preventDefault();Input.mouse.down=1;};ba.ontouchend=e=>{e.preventDefault();Input.mouse.down=0;};
                bd.ontouchstart=e=>{e.preventDefault();Input.keys.space=1;};bd.ontouchend=e=>{e.preventDefault();Input.keys.space=0;};
            }
        };

        // --- WORLD GENERATION (Marble Maze) ---
        const World = {
            ts: 120,
            isWall(x,y) {
                const v = Math.sin(x*0.004) + Math.sin(y*0.004) + Math.sin((x+y)*0.002)*0.5;
                return v > 1.0; 
            },
            collide(x,y,r) {
                const tx=Math.floor(x/this.ts), ty=Math.floor(y/this.ts);
                for(let i=-1;i<=1;i++) for(let j=-1;j<=1;j++) {
                    if(this.isWall((tx+i)*this.ts, (ty+j)*this.ts)) {
                        const wx=(tx+i)*this.ts, wy=(ty+j)*this.ts;
                        const cx=Math.max(wx, Math.min(x, wx+this.ts)), cy=Math.max(wy, Math.min(y, wy+this.ts));
                        if(Math.hypot(x-cx, y-cy)<r) return true;
                    }
                }
                return false;
            },
            draw(ctx, cx, cy) {
                const sc=Math.floor(cx/this.ts), ec=sc+(WIDTH/this.ts)+2;
                const sr=Math.floor(cy/this.ts), er=sr+(HEIGHT/this.ts)+2;
                ctx.fillStyle='#050505'; ctx.fillRect(0,0,WIDTH,HEIGHT);
                for(let c=sc; c<=ec; c++) for(let r=sr; r<=er; r++) {
                    const px=c*this.ts-cx, py=r*this.ts-cy;
                    if(this.isWall(c*this.ts, r*this.ts)) {
                        ctx.fillStyle='#111'; ctx.fillRect(px, py-25, this.ts, this.ts+25); // Base
                        ctx.fillStyle='#222'; ctx.fillRect(px, py-25, this.ts, this.ts); // Topo
                        ctx.strokeStyle='#333'; ctx.lineWidth=2; ctx.strokeRect(px, py-25, this.ts, this.ts);
                        ctx.fillStyle='#1a1a1a'; ctx.fillRect(px+10, py-15, this.ts-20, this.ts-20);
                    } else {
                        ctx.fillStyle=((c+r)%2===0)?'#0f0f0f':'#141414'; ctx.fillRect(px, py, this.ts, this.ts);
                        if(Math.sin(c*12+r*9)>0.9) {
                            ctx.strokeStyle='#222'; ctx.lineWidth=2;
                            ctx.beginPath(); ctx.moveTo(px+20, py+20); ctx.lineTo(px+50, py+50); ctx.lineTo(px+80, py+40); ctx.stroke();
                        }
                    }
                }
            }
        };

        // --- ENTITIES ---
        class Player {
            constructor() {
                this.x=0; this.y=0; this.r=22; this.hp=Stats.maxHp;
                this.a=0; this.atk=0; this.step=0; this.tmr=0; this.cd=0;
                this.dash=0; this.idash=0; this.inv=0; this.moving=false;
                this.addAngle = 0; // Angulo extra para girar o sprite durante ataque
                this.atkDuration = 0; // Para sincronizar o giro
            }
            update() {
                const m=Input.move();
                this.moving = (m.x !== 0 || m.y !== 0);

                if(Input.mobile && Input.joy.on && !this.atk) this.a=Math.atan2(m.y,m.x);
                else this.a=Math.atan2(Input.mouse.wy-this.y, Input.mouse.wx-this.x);

                if(!this.atk || this.step===2) {
                    let s=this.idash?20:Stats.spd;
                    let nx=this.x+m.x*s; if(!World.collide(nx,this.y,this.r))this.x=nx;
                    let ny=this.y+m.y*s; if(!World.collide(this.x,ny,this.r))this.y=ny;
                }

                if(Input.keys.space && this.dash<=0) {
                    this.idash=true; this.dash=35; this.inv=15; this.atk=0; this.step=0;
                    AudioSys.play('dash'); Part.spawn(this.x,this.y,'#fff',10);
                }
                if(this.dash>0)this.dash--; if(this.dash<25)this.idash=false; if(this.inv>0)this.inv--;

                if(this.cd>0)this.cd--; if(this.tmr>0)this.tmr--; else this.step=0;
                if(Input.mouse.down && this.cd<=0 && !this.idash) this.attack();

                // Giro suave sincronizado com a dura√ß√£o da anima√ß√£o
                if (this.atk && this.atkDuration > 0) {
                    this.atkDuration--;
                    // Giro completo 360 (2PI) ao longo de 25 frames
                    const progress = 1 - (this.atkDuration / 25);
                    this.addAngle = progress * Math.PI * 2;
                } else {
                    this.addAngle = 0;
                }
            }
            attack() {
                this.atk=true; this.tmr=50; this.atkDuration = 25;
                AudioSys.play('swing');
                if(Input.mobile) {
                    let e=Manager.ens.find(z=>Math.hypot(z.x-this.x,z.y-this.y)<300);
                    if(e) this.a=Math.atan2(e.y-this.y, e.x-this.x);
                }
                let d=Stats.dmg, r=Stats.range;
                if(this.step===0) { this.cd=15; Vis.addBlade(this.x,this.y,this.a,r,0,Stats.bladeColor); this.step=1; }
                else if(this.step===1) { d*=1.2; this.cd=15; Vis.addBlade(this.x,this.y,this.a,r,1,Stats.bladeColor); this.step=2; }
                else { d*=2.5; r*=1.3; this.cd=40; Vis.addBlade(this.x,this.y,this.a,r,0,Stats.bladeColor,1); Game.shake(15); this.step=0; }
                
                setTimeout(()=>{ 
                    Combat.area(this.x,this.y,this.a,r,2,d); 
                }, 100);
                
                setTimeout(() => { this.atk=false; }, 400);
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x,this.y); 
                if(Effects.giant) ctx.scale(1.4,1.4);
                
                ctx.rotate(this.a + this.addAngle);
                
                if(this.inv>0 && Date.now()%100<50) ctx.globalAlpha=0.5;

                if(Effects.shadow) { ctx.shadowBlur=20; ctx.shadowColor='#000'; }
                if(Effects.gold) { ctx.shadowBlur=20; ctx.shadowColor='gold'; }

                let img = Sprites.idle;
                let size = 120;
                let offset = -60;

                if(this.atk) {
                    img = Sprites.atk;
                    size = 180; // Reduzido de 400 para evitar ficar gigante demais, mas maior que o normal
                    offset = -90;
                }
                else if(this.moving) {
                    img = Sprites.run;
                }

                try {
                    ctx.drawImage(img, offset, offset, size, size);
                } catch(e) {
                    ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fill();
                }

                ctx.restore();
            }
        }

        class Enemy {
            constructor(t,x,y) {
                this.x=x; this.y=y; this.t=t; this.hp=t.hp*(1+Game.diff*0.2); this.max=this.hp;
                this.r=t.r; this.dead=0; this.flash=0; this.state='CHASE'; this.tmr=0; this.vx=0; this.vy=0;
                this.phase=0; this.angle=0;
            }
            update() {
                if(this.dead) return;
                this.x+=this.vx; this.y+=this.vy; this.vx*=0.85; this.vy*=0.85;
                
                if(this.t.boss) this.bossAI(); else this.minionAI();
                if(this.flash>0) this.flash--;
                
                // Update angle for sprite rotation
                this.angle = Math.atan2(Game.p.y - this.y, Game.p.x - this.x);
            }
            minionAI() {
                const d=Math.hypot(Game.p.x-this.x, Game.p.y-this.y);
                if(this.state==='CHASE') {
                    const a=this.angle;
                    let nx=this.x+Math.cos(a)*this.t.spd, ny=this.y+Math.sin(a)*this.t.spd;
                    if(!World.collide(nx,this.y,this.r)) this.x=nx;
                    if(!World.collide(this.x,ny,this.r)) this.y=ny;
                    if(d<this.r+40) { this.state='PREP'; this.tmr=40; }
                } else if(this.state==='PREP') {
                    this.tmr--; if(this.tmr<=0) { this.state='ATK'; if(d<this.r+60) Combat.hitP(this.t.dmg); this.tmr=60; }
                } else if(this.state==='ATK') { this.tmr--; if(this.tmr<=0) this.state='CHASE'; }
            }
            bossAI() {
                const d=Math.hypot(Game.p.x-this.x, Game.p.y-this.y);
                const a=this.angle;
                
                if(this.hp < this.max*0.5 && this.phase===0) {
                    this.phase=1; this.t.spd*=1.4; Part.spawn(this.x,this.y,'#f00',30); Game.shake(20);
                }

                if(this.state==='CHASE') {
                    let nx=this.x+Math.cos(a)*this.t.spd, ny=this.y+Math.sin(a)*this.t.spd;
                    if(!World.collide(nx,this.y,this.r)) this.x=nx; if(!World.collide(this.x,ny,this.r)) this.y=ny;
                    if(Math.random()<0.02) { this.state='PREP'; this.tmr=60; }
                } 
                else if(this.state==='PREP') {
                    this.tmr--;
                    if(this.tmr<=0) {
                        this.state='ATK';
                        if(this.t.id==='hydra') { 
                            for(let i=0;i<4;i++) Part.pool(this.x+(Math.random()-0.5)*150, this.y+(Math.random()-0.5)*150);
                        } else if(this.t.id==='medusa') { 
                            let look=Math.abs(Game.p.a - (a+Math.PI)); while(look>Math.PI)look-=Math.PI*2;
                            if(Math.abs(look)<1) { Combat.hitP(20); Game.p.spd=0; setTimeout(()=>Game.p.spd=Stats.spd, 2000); }
                        } else if(this.t.id==='herc') { 
                            if(d<250) Combat.hitP(this.t.dmg*1.5); Game.shake(30);
                        } else if(this.t.id==='ares') { 
                            for(let i=0;i<3;i++) Part.bullet(this.x,this.y,a+(i-1)*0.3);
                        }
                        this.tmr=60;
                    }
                } else if(this.state==='ATK') { this.tmr--; if(this.tmr<=0) this.state='CHASE'; }
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                
                if(this.flash>0) {
                    ctx.globalCompositeOperation = "source-over";
                    ctx.fillStyle = "white";
                    ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
                } else {
                    // Rotation for sprite
                    ctx.rotate(this.angle);
                    
                    let img = Sprites.e_run;
                    if(this.state === 'ATK') img = Sprites.e_atk;
                    if(this.state === 'PREP') img = Sprites.e_def;
                    
                    let size = this.r * 2.8; // Scale sprite based on radius
                    
                    if(this.t.boss) {
                       ctx.shadowBlur=20; ctx.shadowColor=this.phase?'red':'purple';
                    }
                    
                    try {
                        ctx.drawImage(img, -size/2, -size/2, size, size);
                    } catch(e) {
                        ctx.fillStyle = this.t.color; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
                    }
                }
                
                ctx.restore();
                
                // Health bar outside rotation
                ctx.save(); ctx.translate(this.x, this.y);
                if(this.hp<this.max) { ctx.fillStyle='red'; ctx.fillRect(-20,-this.r-15,40*(this.hp/this.max),5); }
                ctx.restore();
            }
            hit(d) {
                if(Effects.fire) d+=5;
                this.hp-=d; this.flash=5;
                let a=Math.atan2(this.y-Game.p.y, this.x-Game.p.x);
                // Apply knockback velocity
                this.vx = Math.cos(a) * 15; 
                this.vy = Math.sin(a) * 15;
                
                Vis.addNum(this.x,this.y,Math.floor(d));
                if(this.hp<=0) { this.dead=true; Game.kill(this); Part.spawn(this.x,this.y,this.t.color,10); }
            }
        }

        // --- MANAGERS ---
        const Manager = {
            ens: [], arts: [],
            types: {
                skel: {id:'skel', hp:60, spd:2.5, r:18, color:'#bdc3c7', dmg:15, xp:20},
                glad: {id:'glad', hp:150, spd:2, r:25, color:'#7f8c8d', dmg:25, xp:40},
                mino: {id:'mino', hp:400, spd:3.5, r:35, color:'#5e3a28', dmg:40, xp:80},
                hydra: {id:'hydra', hp:3000, spd:1.5, r:70, color:'#2ecc71', dmg:50, xp:1000, boss:1, name:"Hidra Venenosa"},
                medusa: {id:'medusa', hp:4000, spd:3.5, r:60, color:'#27ae60', dmg:60, xp:1500, boss:1, name:"Medusa Maldita"},
                herc: {id:'herc', hp:6000, spd:4.5, r:65, color:'#f39c12', dmg:80, xp:2000, boss:1, name:"H√©rcules"},
                ares: {id:'ares', hp:10000, spd:5.5, r:80, color:'#e74c3c', dmg:100, xp:5000, boss:1, name:"ARES"}
            },
            spawnEn(t, px, py) {
                let x,y,ok=false;
                for(let i=0;i<20;i++) {
                    let a=Math.random()*6.28, d=px ? i*20 : 400+Math.random()*400;
                    x = (px||Game.p.x) + Math.cos(a)*d;
                    y = (py||Game.p.y) + Math.sin(a)*d;
                    if(!World.collide(x,y,40)) { ok=true; break; }
                }
                if(ok) this.ens.push(new Enemy(this.types[t],x,y));
            },
            spawnArt(n) {
                for(let i=0;i<n;i++) {
                    let ok=false,x,y;
                    for(let k=0;k<20;k++) {
                        let a=Math.random()*6.28, d=300+Math.random()*1000;
                        x=Game.p.x+Math.cos(a)*d; y=Game.p.y+Math.sin(a)*d;
                        if(!World.collide(x,y,30)){ok=true;break;}
                    }
                    if(ok) this.arts.push({x,y,ty:0});
                }
            }
        };

        const Combat = {
            area(x,y,a,r,arc,d) {
                let h=0;
                Manager.ens.forEach(e=>{
                    if(Math.hypot(e.x-x,e.y-y)<r+e.r) {
                        let dif=Math.atan2(e.y-y,e.x-x)-a;
                        while(dif>Math.PI)dif-=Math.PI*2; while(dif<-Math.PI)dif+=Math.PI*2;
                        if(Math.abs(dif)<arc/2) { e.hit(d); h++; }
                    }
                });
                if(h>0) { Game.combo(h); Game.shake(h*3); }
            },
            hitP(d) {
                if(Game.p.inv>0)return; if(Stats.reflect>0)d*=0.5;
                Game.p.hp-=d; Game.p.inv=30; Game.shake(20); AudioSys.play('hit');
                Vis.addNum(Game.p.x, Game.p.y, `-${Math.floor(d)}`, '#c0392b');
                document.getElementById('hp-bar').style.width=(Game.p.hp/Stats.maxHp*100)+'%';
                if(Game.p.hp<=0) Game.over();
            }
        };

        const Part = {
            l: [],
            update() {
                this.l.forEach(p=>{
                    if(p.type==='b') {
                        if(Math.hypot(Game.p.x-p.x,Game.p.y-p.y)<20) { Combat.hitP(p.dmg); p.l=0; }
                        p.x+=p.vx; p.y+=p.vy;
                    } else if(p.type==='p') {
                        if(Math.hypot(Game.p.x-p.x,Game.p.y-p.y)<30) Combat.hitP(p.dmg);
                    } else { p.x+=p.vx; p.y+=p.vy; }
                    p.l--; 
                });
                this.l=this.l.filter(p=>p.l>0);
            },
            draw(ctx) {
                this.l.forEach(p=>{
                    ctx.fillStyle=p.c; 
                    if(p.type==='p') { ctx.globalAlpha=0.5; ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,6.28); ctx.fill(); ctx.globalAlpha=1; }
                    else ctx.fillRect(p.x,p.y,p.s,p.s);
                });
            },
            spawn(x,y,c,n) { for(let i=0;i<n;i++) this.l.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,l:30,c,s:Math.random()*5+2}); },
            bullet(x,y,a) { this.l.push({x,y,vx:Math.cos(a)*10,vy:Math.sin(a)*10,l:80,c:'#a0f',s:10,type:'b',dmg:20}); },
            pool(x,y) { this.l.push({x,y,vx:0,vy:0,l:200,c:'#0f0',s:30,type:'p',dmg:1}); }
        };

        const Vis = {
            b: [], n: [],
            addBlade(x,y,a,r,f,c,h) { this.b.push({x,y,a,r,f,c,h,l:12,m:12}); },
            addNum(x,y,v,c='#fff') { this.n.push({x,y:y-30,v,c,l:40}); },
            draw(ctx) {
                this.b.forEach(i=>{
                    i.l--; let p=1-(i.l/i.m), s=i.f?-1:1;
                    ctx.save(); ctx.translate(i.x,i.y); ctx.rotate(i.a);
                    ctx.shadowBlur=15; ctx.shadowColor=i.c; ctx.strokeStyle=i.c; ctx.lineWidth=i.h?10:6;
                    ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(i.r/2, i.r/3*s, i.r, Math.sin(p*s)*i.r*s); ctx.stroke();
                    ctx.restore();
                });
                this.b=this.b.filter(i=>i.l>0);
                ctx.font="bold 24px Arial"; ctx.textAlign="center";
                this.n.forEach(i=>{
                    i.l--; ctx.fillStyle=i.c; ctx.fillText(i.v,i.x,i.y-=1);
                });
                this.n=this.n.filter(i=>i.l>0);
            }
        };

        const Game = {
            p:null, diff:1, xp:0, nxp:100, arts:0, bk:0, bossOn:0, nBoss:5, cam:{x:0,y:0,s:0}, c:0, ct:0, st:0,
            start() {
                Input.init(); AudioSys.init();
                this.p=new Player(); Manager.ens=[]; Manager.arts=[]; Part.l=[]; Vis.b=[]; Vis.n=[];
                this.diff=1; this.xp=0; this.arts=0; this.bk=0; this.nBoss=5; this.st=Date.now();
                
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('game-over-screen').classList.add('hidden');
                document.getElementById('end-screen').classList.add('hidden');
                
                this.updArt(); Manager.spawnArt(10);
                gameState='PLAY'; this.loop();
            },
            shake(a) { this.cam.s=a; },
            combo(n) {
                this.c+=n; this.ct=100; 
                document.getElementById('combo-container').style.opacity=1;
                document.getElementById('combo-count').innerText=this.c;
                document.getElementById('combo-container').style.transform='scale(1.2)';
                setTimeout(()=>document.getElementById('combo-container').style.transform='scale(1)', 100);
            },
            updArt() { document.getElementById('artifact-ui').innerText=`${this.arts}/${this.nBoss}`; },
            spawnBoss() {
                this.bossOn=true; AudioSys.play('boss');
                let t='hydra'; if(this.bk==1)t='medusa'; if(this.bk==2)t='herc'; if(this.bk==3)t='ares';
                
                let bx=this.p.x+300, by=this.p.y;
                Manager.spawnEn(t, bx, by);
                
                document.getElementById('boss-hud').style.display='block';
                document.getElementById('boss-name').innerText=Manager.types[t].name;
            },
            kill(e) {
                this.xp+=e.t.xp;
                if(this.xp>=this.nxp) { this.xp-=this.nxp; this.nxp*=1.4; this.card(); }
                document.getElementById('xp-bar').style.width=(this.xp/this.nxp*100)+'%';
                
                if(e.t.boss) {
                    this.bk++; this.bossOn=false; document.getElementById('boss-hud').style.display='none';
                    if(this.bk>=4) this.win();
                    else { this.diff+=3; this.nBoss+=5; this.updArt(); Manager.spawnArt(5); }
                }
            },
            getArt() {
                this.arts++; AudioSys.play('art'); Part.spawn(this.p.x,this.p.y,'gold',15);
                this.updArt();
                if(!this.bossOn && this.arts>=this.nBoss) this.spawnBoss();
            },
            card() {
                gameState='PAUSE';
                const d=document.getElementById('upgrade-cards'); d.innerHTML='';
                Upgrades.sort(()=>Math.random()-0.5).slice(0,3).forEach(u=>{
                    const c=document.createElement('div'); c.className='card legendary';
                    c.innerHTML=`<div class="card-icon">${u.i}</div><h3>${u.t}</h3><p>${u.d}</p>`;
                    c.onclick=()=>{u.f(); document.getElementById('upgrade-screen').classList.add('hidden'); gameState='PLAY'; this.loop();};
                    d.appendChild(c);
                });
                document.getElementById('upgrade-screen').classList.remove('hidden');
            },
            update() {
                this.p.update();
                Manager.ens.forEach(e=>e.update());
                Manager.ens=Manager.ens.filter(e=>!e.dead);
                
                if(!this.bossOn && Manager.ens.length<12+this.diff) {
                    let r=Math.random(), t='skel'; if(this.diff>2&&r>0.7)t='glad'; if(this.diff>5&&r>0.9)t='mino';
                    Manager.spawnEn(t);
                }

                Manager.arts.forEach(a=>{
                    a.ty+=0.1;
                    if(Math.hypot(this.p.x-a.x,this.p.y-a.y)<50) { a.dead=true; this.getArt(); }
                });
                Manager.arts=Manager.arts.filter(a=>!a.dead);
                if(!this.bossOn && Manager.arts.length<3) Manager.spawnArt(1);

                Part.update();

                let tx=this.p.x-WIDTH/2, ty=this.p.y-HEIGHT/2;
                this.cam.x+=(tx-this.cam.x)*0.1; this.cam.y+=(ty-this.cam.y)*0.1;
                if(this.cam.s>0){this.cam.x+=(Math.random()-0.5)*this.cam.s;this.cam.y+=(Math.random()-0.5)*this.cam.s;this.cam.s*=0.9;}
                Input.updateWorld(this.cam.x, this.cam.y);

                let el=Math.floor((Date.now()-this.st)/1000);
                document.getElementById('timer').innerText=`${Math.floor(el/60)}:${(el%60).toString().padStart(2,'0')}`;

                if(this.bossOn) {
                    let b=Manager.ens.find(e=>e.t.boss);
                    if(b) document.getElementById('boss-hp').style.width=(b.hp/b.max*100)+'%';
                }
                
                if(this.ct>0)this.ct--; else { this.c=0; document.getElementById('combo-container').style.opacity=0; }
            },
            draw() {
                ctx.fillStyle='#000'; ctx.fillRect(0,0,WIDTH,HEIGHT);
                World.draw(ctx, this.cam.x, this.cam.y);
                
                const g=ctx.createRadialGradient(WIDTH/2,HEIGHT/2,200,WIDTH/2,HEIGHT/2,800);
                g.addColorStop(0,"rgba(0,0,0,0)"); g.addColorStop(1,"rgba(0,0,0,0.85)");
                ctx.fillStyle=g; ctx.fillRect(0,0,WIDTH,HEIGHT);

                ctx.save(); ctx.translate(-this.cam.x,-this.cam.y);
                Manager.arts.forEach(a=>{
                    ctx.save(); ctx.translate(a.x,a.y+Math.sin(a.ty)*5);
                    ctx.fillStyle='#f1c40f'; ctx.shadowBlur=20; ctx.shadowColor='gold';
                    ctx.beginPath(); ctx.moveTo(-10,-10); ctx.lineTo(10,-10); ctx.lineTo(5,10); ctx.lineTo(-5,10); ctx.fill();
                    ctx.restore();
                });
                Part.draw(ctx);
                Manager.ens.forEach(e=>e.draw(ctx));
                this.p.draw(ctx);
                Vis.draw(ctx);
                ctx.restore();
            },
            loop() { if(gameState==='PLAY') { this.update(); this.draw(); requestAnimationFrame(()=>this.loop()); } },
            win() { gameState='WIN'; document.getElementById('end-screen').classList.remove('hidden'); },
            over() { gameState='OVER'; document.getElementById('game-over-screen').classList.remove('hidden'); }
        };
    </script>
</body>