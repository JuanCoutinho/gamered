<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fantasma de Esparta: A Vingan√ßa</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');

        body {
            margin: 0; overflow: hidden; background-color: #050505;
            font-family: 'Cinzel', serif; color: white; user-select: none; touch-action: none;
        }
        #gameCanvas { display: block; cursor: crosshair; }

        /* UI Overlay */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; z-index: 10;
        }

        /* HUD Elements */
        .top-hud {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            width: 100%;
            align-items: start;
        }

        .player-stats { display: flex; flex-direction: column; gap: 5px; }
        
        .health-frame {
            width: 300px; height: 25px; background: #111; border: 2px solid #a67c00;
            transform: skewX(-10deg); overflow: hidden; box-shadow: 0 0 15px #000;
        }
        .health-fill { height: 100%; background: linear-gradient(90deg, #600, #f00); width: 100%; transition: width 0.1s; }
        
        .xp-frame {
            width: 250px; height: 6px; background: #000; border: 1px solid #555;
            transform: skewX(-10deg);
        }
        .xp-fill { height: 100%; background: linear-gradient(90deg, #d35400, #f1c40f); width: 0%; transition: width 0.2s; }

        .timer-container {
            text-align: center;
        }
        .timer {
            font-size: 40px; font-weight: 900; color: #ecf0f1;
            text-shadow: 0 0 10px #000; letter-spacing: 2px;
        }

        .objective-panel { text-align: right; }
        .artifact-counter { font-size: 24px; color: #f1c40f; font-weight: bold; text-shadow: 0 0 15px #f1c40f; }

        /* Boss Bar */
        #boss-hud {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            width: 70%; display: none; text-align: center;
        }
        .boss-title { font-size: 32px; color: #e74c3c; text-shadow: 0 0 20px #000; font-weight: 900; }
        .boss-bar-frame { 
            width: 100%; height: 25px; background: #222; border: 3px solid #555; 
            margin-top: 5px; box-shadow: 0 0 30px rgba(231, 76, 60, 0.6); 
        }
        .boss-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #4a0e0e, #e74c3c); transition: width 0.1s; }

        /* Combo Text */
        #combo-text {
            position: absolute; left: 20px; bottom: 20px;
            font-size: 50px; font-weight: 900; font-style: italic; color: #f1c40f;
            text-shadow: 3px 3px 0 #c0392b; opacity: 0; transition: transform 0.1s;
        }

        /* Mobile Controls */
        #mobile-controls { display: none; position: absolute; bottom: 20px; left: 0; width: 100%; height: 150px; pointer-events: none; }
        .joystick-area { position: absolute; bottom: 20px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); pointer-events: auto; }
        .joystick-knob { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%,-50%); pointer-events: none; }
        .action-buttons { position: absolute; bottom: 20px; right: 40px; display: flex; gap: 20px; align-items: flex-end; pointer-events: auto; }
        .btn-mobile { border-radius: 50%; background: rgba(192,57,43,0.6); border: 2px solid #fff; color: white; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; user-select: none; }
        .btn-attack { width: 90px; height: 90px; background: rgba(192,57,43,0.7); }
        .btn-dash { width: 60px; height: 60px; background: rgba(241,196,15,0.6); margin-bottom: 20px; }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(10,10,10,0.98) 0%, rgba(0,0,0,1) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; pointer-events: auto; text-align: center;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 60px; color: #c0392b; margin: 0; text-shadow: 0 0 30px #f00; letter-spacing: 5px; font-weight: 900; }
        h2 { color: #f1c40f; margin-bottom: 20px; font-size: 24px; }
        p { color: #aaa; max-width: 700px; margin-bottom: 30px; font-size: 18px; }

        button.menu-btn {
            padding: 15px 50px; font-family: 'Cinzel', serif; font-size: 24px;
            background: #111; color: #f1c40f; border: 2px solid #f1c40f;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; font-weight: bold;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.2);
        }
        button.menu-btn:hover { background: #f1c40f; color: #000; box-shadow: 0 0 30px #f1c40f; transform: scale(1.05); }

        /* Upgrade Cards Grid */
        .cards-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; max-width: 1200px; }
        .card {
            width: 180px; height: 260px; background: linear-gradient(160deg, #1a1a1a, #2c3e50);
            border: 2px solid #555; padding: 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            position: relative; box-shadow: 0 0 10px #000;
        }
        .card:hover { transform: translateY(-10px) scale(1.05); border-color: #f1c40f; z-index: 10; }
        .card h3 { color: #f1c40f; font-size: 16px; margin: 10px 0; text-align: center; }
        .card-icon { font-size: 50px; margin: 10px 0; }
        .card p { font-size: 12px; color: #bbb; text-align: center; }

        #mute-btn {
            position: absolute; bottom: 20px; left: 20px; background: none;
            border: none; color: #777; font-size: 30px; cursor: pointer; pointer-events: auto; z-index: 30;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="top-hud">
            <div class="player-stats">
                <div class="health-frame"><div class="health-fill" id="hp-bar"></div></div>
                <div class="xp-frame"><div class="xp-fill" id="xp-bar"></div></div>
            </div>
            <div class="timer-container">
                <div class="timer" id="timer">00:00</div>
            </div>
            <div class="objective-panel">
                <div class="artifact-counter" id="artifact-ui">Artefatos: 0/5</div>
            </div>
        </div>

        <div id="boss-hud">
            <div class="boss-title" id="boss-name">BOSS</div>
            <div class="boss-bar-frame"><div class="boss-bar-fill" id="boss-hp"></div></div>
        </div>

        <div id="combo-text">0 HITS</div>
        <button id="mute-btn" onclick="toggleMute()">üîä</button>
    </div>

    <div id="mobile-controls">
        <div class="joystick-area" id="joystick"><div class="joystick-knob" id="knob"></div></div>
        <div class="action-buttons">
            <div class="btn-mobile btn-dash" id="btn-dash">‚ö°</div>
            <div class="btn-mobile btn-attack" id="btn-attack">‚öîÔ∏è</div>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <h1>Fantasma de Esparta</h1>
        <h2>A Vingan√ßa</h2>
        <p>Colete <b>Artefatos</b> para invocar os Generais do Olimpo.<br>Cada Boss tem mec√¢nicas √∫nicas. Prepare-se.</p>
        <button class="menu-btn" onclick="Game.start()">Come√ßar</button>
    </div>

    <div id="upgrade-screen" class="screen hidden">
        <h2>Ben√ß√£o do Olimpo</h2>
        <div class="cards-container" id="upgrade-cards"></div>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="color: #7f8c8d;">Derrotado</h1>
        <button class="menu-btn" onclick="location.reload()">Tentar de Novo</button>
    </div>

    <div id="end-screen" class="screen hidden">
        <h1 style="color: #f1c40f;">DEUS DA GUERRA</h1>
        <p id="end-time">Tempo Final: 00:00</p>
        <button class="menu-btn" onclick="location.reload()">Jogar Novamente</button>
    </div>

    <script>
        let gameState = 'MENU';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let WIDTH, HEIGHT;

        const resize = () => { WIDTH = window.innerWidth; HEIGHT = window.innerHeight; canvas.width = WIDTH; canvas.height = HEIGHT; };
        window.addEventListener('resize', resize);
        resize();

        // --- CONFIGURA√á√ÉO DE JOGO & VISUAIS ---
        const Stats = {
            dmg: 30, spd: 6, maxHp: 100, crit: 0.05, vamp: 0, 
            reflect: 0, bladeColor: '#e74c3c', range: 160
        };
        
        const Effects = {
            fire: false, ice: false, lightning: false, necro: false, 
            giant: false, gold: false, shadow: false, multi: false, 
            poison: false, thorns: false
        };

        // --- 15 CARTAS ROGUELITE ---
        const Upgrades = [
            {t:"L√¢minas do Caos", i:"üî•", d:"+Dano e Fogo", f:()=>{Stats.dmg*=1.2; Effects.fire=true; Stats.bladeColor='#ff4500';}},
            {t:"Sand√°lias de Hermes", i:"üëü", d:"+Velocidade Movimento", f:()=>{Stats.spd*=1.2;}},
            {t:"Velocino de Ouro", i:"üõ°Ô∏è", d:"Reflete Dano", f:()=>{Effects.thorns=true; Stats.reflect=0.5;}},
            {t:"Olhar da Medusa", i:"‚ùÑÔ∏è", d:"Chance de Congelar", f:()=>{Effects.ice=true;}},
            {t:"F√∫ria de Zeus", i:"‚ö°", d:"Raios nos Ataques", f:()=>{Effects.lightning=true;}},
            {t:"Cora√ß√£o de Gaia", i:"üíö", d:"+50% Vida M√°xima", f:()=>{Stats.maxHp*=1.5; Game.p.hp+=50;}},
            {t:"Toque de Midas", i:"üí∞", d:"Inimigos viram Ouro (Cura)", f:()=>{Effects.gold=true;}},
            {t:"Necromancia", i:"üíÄ", d:"Explos√µes ao Matar", f:()=>{Effects.necro=true;}},
            {t:"Sangue dos Deuses", i:"ü©∏", d:"Roubo de Vida (Vampirismo)", f:()=>{Stats.vamp+=0.05;}},
            {t:"Tamanho de Tit√£", i:"üóø", d:"Voc√™ fica Gigante (+Alcance)", f:()=>{Effects.giant=true; Stats.range*=1.3;}},
            {t:"Arco de Apolo", i:"üèπ", d:"Dispara proj√©teis ao atacar", f:()=>{Effects.multi=true;}},
            {t:"Sombra de Hades", i:"üåë", d:"Fica invis√≠vel no Dash", f:()=>{Effects.shadow=true;}},
            {t:"Veneno da Hidra", i:"üß™", d:"Dano cont√≠nuo nos inimigos", f:()=>{Effects.poison=true;}},
            {t:"F√∫ria Espartana", i:"üò°", d:"+30% Dano Base", f:()=>{Stats.dmg*=1.3;}},
            {t:"Ben√ß√£o de Atena", i:"ü¶â", d:"Cura Total + XP B√¥nus", f:()=>{Game.p.hp=Stats.maxHp; Game.nxp=Math.floor(Game.nxp*0.8);}}
        ];

        // --- √ÅUDIO ---
        const Sound = {
            ctx: null, muted: false,
            init() { if(!this.ctx){window.AudioContext=window.AudioContext||window.webkitAudioContext;this.ctx=new AudioContext();} if(this.ctx.state==='suspended')this.ctx.resume(); },
            play(t) {
                if(this.muted||!this.ctx) return; if(this.ctx.state==='suspended')this.ctx.resume();
                const n=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                if(t==='hit'){o.type='sawtooth';o.frequency.setValueAtTime(100,n);o.frequency.linearRampToValueAtTime(10,n+0.1);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.1);}
                else if(t==='swing'){o.type='triangle';o.frequency.setValueAtTime(200,n);o.frequency.linearRampToValueAtTime(50,n+0.3);g.gain.setValueAtTime(0.05,n);g.gain.linearRampToValueAtTime(0,n+0.3);}
                else if(t==='art'){o.type='sine';o.frequency.setValueAtTime(600,n);o.frequency.linearRampToValueAtTime(1000,n+0.5);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.5);}
                else if(t==='boss'){o.type='square';o.frequency.setValueAtTime(50,n);o.frequency.linearRampToValueAtTime(20,n+1);g.gain.setValueAtTime(0.2,n);g.gain.linearRampToValueAtTime(0,n+1);}
                o.start(n); o.stop(n+(t==='boss'?1:0.4));
            }
        };
        function toggleMute(){ Sound.muted=!Sound.muted; document.getElementById('mute-btn').innerText=Sound.muted?'üîá':'üîä'; if(!Sound.muted)Sound.init(); }

        // --- INPUT ---
        const Input = {
            keys:{w:0,a:0,s:0,d:0,space:0}, mouse:{x:0,y:0,down:0,wx:0,wy:0}, joy:{on:0,dx:0,dy:0}, mobile:0,
            init() {
                window.onkeydown=e=>{if('wasd'.includes(e.key.toLowerCase()))Input.keys[e.key.toLowerCase()]=1;if(e.code==='Space')Input.keys.space=1;};
                window.onkeyup=e=>{if('wasd'.includes(e.key.toLowerCase()))Input.keys[e.key.toLowerCase()]=0;if(e.code==='Space')Input.keys.space=0;};
                window.onmousemove=e=>{const r=canvas.getBoundingClientRect();Input.mouse.x=e.clientX-r.left;Input.mouse.y=e.clientY-r.top;};
                window.onmousedown=()=>{Sound.init();Input.mouse.down=1;}; window.onmouseup=()=>{Input.mouse.down=0;};
                document.body.ontouchstart=()=>{Input.mobile=1;Sound.init();document.getElementById('mobile-controls').style.display='block';};
                this.setupJoy();
            },
            updateWorld(cx,cy){this.mouse.wx=this.mouse.x+cx;this.mouse.wy=this.mouse.y+cy;},
            move(){
                let dx=0,dy=0;
                if(this.joy.on){dx=this.joy.dx;dy=this.joy.dy;}
                else{if(this.keys.w)dy=-1;if(this.keys.s)dy=1;if(this.keys.a)dx=-1;if(this.keys.d)dx=1;}
                const l=Math.hypot(dx,dy); if(l>1||(!this.joy.on&&l>0)){dx/=l;dy/=l;}
                return {x:dx,y:dy};
            },
            setupJoy(){
                const j=document.getElementById('joystick'), k=document.getElementById('knob'); let sx,sy;
                j.ontouchstart=e=>{e.preventDefault();sx=e.touches[0].clientX;sy=e.touches[0].clientY;Input.joy.on=1;};
                j.ontouchmove=e=>{e.preventDefault();if(!Input.joy.on)return;const dx=e.touches[0].clientX-sx,dy=e.touches[0].clientY-sy,d=Math.hypot(dx,dy),m=40,c=Math.min(d,m),a=Math.atan2(dy,dx);k.style.transform=`translate(calc(-50% + ${Math.cos(a)*c}px),calc(-50% + ${Math.sin(a)*c}px))`;Input.joy.dx=Math.cos(a)*(c/m);Input.joy.dy=Math.sin(a)*(c/m);};
                const end=()=>{Input.joy.on=0;Input.joy.dx=0;Input.joy.dy=0;k.style.transform='translate(-50%,-50%)';};
                j.ontouchend=end;j.ontouchcancel=end;
                const bA=document.getElementById('btn-attack'),bD=document.getElementById('btn-dash');
                bA.ontouchstart=e=>{e.preventDefault();Input.mouse.down=1;};bA.ontouchend=e=>{e.preventDefault();Input.mouse.down=0;};
                bD.ontouchstart=e=>{e.preventDefault();Input.keys.space=1;};bD.ontouchend=e=>{e.preventDefault();Input.keys.space=0;};
            }
        };

        // --- WORLD ---
        const World = {
            ts: 100,
            isWall(x,y) {
                const v = Math.sin(x*0.005) + Math.sin(y*0.005) + Math.sin((x+y)*0.003);
                return v > 1.1;
            },
            collide(x,y,r) {
                const tx=Math.floor(x/this.ts), ty=Math.floor(y/this.ts);
                for(let i=-1;i<=1;i++) for(let j=-1;j<=1;j++) {
                    if(this.isWall((tx+i)*this.ts, (ty+j)*this.ts)) {
                        const wx=(tx+i)*this.ts, wy=(ty+j)*this.ts;
                        const cx=Math.max(wx, Math.min(x, wx+this.ts)), cy=Math.max(wy, Math.min(y, wy+this.ts));
                        if(Math.hypot(x-cx, y-cy)<r) return true;
                    }
                }
                return false;
            },
            draw(ctx,cx,cy) {
                const sc=Math.floor(cx/this.ts), ec=sc+(WIDTH/this.ts)+2, sr=Math.floor(cy/this.ts), er=sr+(HEIGHT/this.ts)+2;
                ctx.fillStyle='#050505'; ctx.fillRect(0,0,WIDTH,HEIGHT);
                for(let c=sc; c<=ec; c++) for(let r=sr; r<=er; r++) {
                    const px=c*this.ts-cx, py=r*this.ts-cy;
                    if(this.isWall(c*this.ts, r*this.ts)) {
                        ctx.fillStyle='#1a1a1a'; ctx.fillRect(px, py-15, this.ts, this.ts+15);
                        ctx.fillStyle='#222'; ctx.fillRect(px, py-15, this.ts, this.ts);
                    } else {
                        ctx.fillStyle=((c+r)%2==0)?'#0d0d0d':'#111'; ctx.fillRect(px, py, this.ts, this.ts);
                        if(Math.abs(Math.sin(c*r))>0.95) {
                            ctx.fillStyle='#1a1a1a'; ctx.beginPath(); ctx.arc(px+50, py+50, 10, 0, Math.PI*2); ctx.fill();
                        }
                    }
                }
            }
        };

        // --- PLAYER ---
        class Player {
            constructor() {
                this.x=0; this.y=0; this.r=20; this.hp=Stats.maxHp;
                this.angle=0; this.atk=0; this.step=0; this.tmr=0; this.cd=0; 
                this.dash=0; this.idash=0; this.inv=0;
            }
            update() {
                const m=Input.move();
                if(Input.mobile && Input.joy.on && !this.atk) this.angle=Math.atan2(m.y,m.x);
                else this.angle=Math.atan2(Input.mouse.wy-this.y, Input.mouse.wx-this.x);

                if(!this.atk || this.step===2) {
                    let spd = this.idash ? 18 : Stats.spd;
                    let nx = this.x + m.x*spd; if(!World.collide(nx,this.y,this.r)) this.x=nx;
                    let ny = this.y + m.y*spd; if(!World.collide(this.x,ny,this.r)) this.y=ny;
                }

                if(Input.keys.space && this.dash<=0) {
                    this.idash=true; this.dash=30; this.inv=15; this.atk=false; this.step=0;
                    Sound.play('dash');
                }
                if(this.dash>0)this.dash--; if(this.dash<20)this.idash=false; if(this.inv>0)this.inv--;

                if(this.cd>0)this.cd--; if(this.tmr>0)this.tmr--; else this.step=0;
                if(Input.mouse.down && this.cd<=0 && !this.idash) this.attack();
            }
            attack() {
                this.atk=true; this.tmr=50; Sound.play('swing');
                if(Input.mobile) {
                    let c=Enemies.l.find(e=>Math.hypot(e.x-this.x,e.y-this.y)<250);
                    if(c) this.angle=Math.atan2(c.y-this.y, c.x-this.x);
                }
                let d=Stats.dmg, r=Stats.range;
                if(this.step===0) { this.cd=15; Vis.blade(this.x, this.y, this.angle, r, false); this.step=1; }
                else if(this.step===1) { d*=1.2; this.cd=15; Vis.blade(this.x, this.y, this.angle, r, true); this.step=2; }
                else { d*=2.5; r*=1.2; this.cd=40; Vis.blade(this.x, this.y, this.angle, r, false, true); Game.shake(15); this.step=0; }
                
                if(Effects.lightning) Part.bolt(this.x+Math.cos(this.angle)*150, this.y+Math.sin(this.angle)*150);
                if(Effects.multi) Part.bullet(this.x, this.y, this.angle, true);

                setTimeout(()=>{ Combat.area(this.x, this.y, this.angle, r, 2, d); this.atk=false; }, 100);
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                if(Effects.giant) ctx.scale(1.5, 1.5);
                ctx.rotate(this.angle);
                if(this.inv>0 && Date.now()%100<50) ctx.globalAlpha=0.5;
                
                if(Effects.shadow) { ctx.shadowBlur=15; ctx.shadowColor='#000'; }
                if(Effects.gold) { ctx.shadowBlur=15; ctx.shadowColor='gold'; }

                ctx.fillStyle='#ecf0f1'; ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill(); // Head
                ctx.strokeStyle='#c0392b'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(-5,-15); ctx.lineTo(0,0); ctx.lineTo(-10,15); ctx.stroke(); // Tattoo
                
                // Hands
                ctx.fillStyle='#bdc3c7';
                ctx.beginPath(); ctx.arc(15, 15, 8, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(15, -15, 8, 0, Math.PI*2); ctx.fill();
                
                if(!this.atk) {
                    ctx.strokeStyle='#555'; ctx.lineWidth=3;
                    ctx.beginPath(); ctx.moveTo(15,15); ctx.lineTo(5, 30); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(15,-15); ctx.lineTo(5, -30); ctx.stroke();
                }
                ctx.restore();
            }
        }

        // --- ENEMIES & BOSSES ---
        class Enemy {
            constructor(t,x,y) {
                this.x=x; this.y=y; this.t=t; this.hp=t.hp*(1+Game.diff*0.2); this.max=this.hp;
                this.r=t.r; this.dead=0; this.flash=0; this.frozen=0;
                this.state='CHASE'; this.tmr=0; this.vx=0; this.vy=0;
            }
            update() {
                if(this.dead) return;
                if(this.frozen>0) { this.frozen--; return; }
                this.x+=this.vx; this.y+=this.vy; this.vx*=0.85; this.vy*=0.85;

                // Boss AI Logic
                if(this.t.boss) this.bossAI();
                else this.minionAI();

                if(this.flash>0) this.flash--;
            }
            minionAI() {
                const d=Math.hypot(Game.p.x-this.x, Game.p.y-this.y);
                if(this.state==='CHASE') {
                    const a=Math.atan2(Game.p.y-this.y, Game.p.x-this.x);
                    let nx=this.x+Math.cos(a)*this.t.spd, ny=this.y+Math.sin(a)*this.t.spd;
                    if(!World.collide(nx,this.y,this.r)) this.x=nx;
                    if(!World.collide(this.x,ny,this.r)) this.y=ny;
                    if(d<this.r+40) { this.state='PREP'; this.tmr=30; }
                } else if(this.state==='PREP') {
                    this.tmr--; if(this.tmr<=0) { this.state='ATK'; if(d<this.r+60) Combat.hitP(this.t.dmg); this.tmr=60; }
                } else if(this.state==='ATK') { this.tmr--; if(this.tmr<=0) this.state='CHASE'; }
            }
            bossAI() {
                const d=Math.hypot(Game.p.x-this.x, Game.p.y-this.y);
                const a=Math.atan2(Game.p.y-this.y, Game.p.x-this.x);
                
                if(this.state==='CHASE') {
                    let spd = this.t.spd * (this.hp < this.max*0.5 ? 1.5 : 1); // Rage Mode
                    let nx=this.x+Math.cos(a)*spd, ny=this.y+Math.sin(a)*spd;
                    if(!World.collide(nx,this.y,this.r)) this.x=nx; if(!World.collide(this.x,ny,this.r)) this.y=ny;
                    
                    if(Math.random()<0.01) { this.state='PREP'; this.tmr=50; } // Random Attack
                } else if(this.state==='PREP') {
                    this.tmr--; 
                    if(this.tmr<=0) {
                        this.state='ATK';
                        // Unique Attacks
                        if(this.t.name.includes("Hidra")) { // Poison Pools
                            for(let i=0; i<3; i++) Part.puddle(this.x+(Math.random()-0.5)*100, this.y+(Math.random()-0.5)*100);
                        } else if(this.t.name.includes("Medusa")) { // Stone Gaze
                            let diff = Math.abs(Game.p.angle - (a + Math.PI)); // Check looking
                            if(diff < 1) { Game.p.inv=0; Combat.hitP(10); Game.p.spd=0; setTimeout(()=>Game.p.spd=6, 2000); }
                        } else if(this.t.name.includes("H√©rcules")) { // Slam
                            if(d < 200) Combat.hitP(this.t.dmg*1.5); Game.shake(30);
                        } else if(this.t.name.includes("ARES")) { // Swords
                            Part.bullet(this.x, this.y, a, false); Part.bullet(this.x, this.y, a+0.2, false); Part.bullet(this.x, this.y, a-0.2, false);
                        }
                        this.tmr=60;
                    }
                } else if(this.state==='ATK') { this.tmr--; if(this.tmr<=0) this.state='CHASE'; }
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                if(this.flash>0) ctx.fillStyle='#fff'; 
                else if(this.frozen>0) ctx.fillStyle='#0ff';
                else if(Effects.gold && this.dead) ctx.fillStyle='gold';
                else ctx.fillStyle=this.t.color;
                
                ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
                if(this.t.boss) { 
                    ctx.shadowBlur=20; ctx.shadowColor=this.hp<this.max*0.5?'red':'purple'; 
                    ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.stroke();
                }
                if(this.state==='PREP') { ctx.strokeStyle='red'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,this.r+10,0,Math.PI*2); ctx.stroke(); }
                ctx.restore();
            }
            hit(d) {
                this.hp-=d; this.flash=5;
                const a=Math.atan2(this.y-Game.p.y, this.x-Game.p.x);
                this.vx=Math.cos(a)*10; this.vy=Math.sin(a)*10;
                Vis.num(this.x, this.y, Math.floor(d));
                if(this.hp<=0) { this.dead=true; Game.kill(this); }
            }
        }

        // --- OBJECTS ---
        const Enemies = {
            l: [],
            types: {
                skel:{hp:60,spd:2.5,r:20,color:'#bdc3c7',dmg:15,xp:20},
                glad:{hp:150,spd:2,r:25,color:'#7f8c8d',dmg:25,xp:40},
                mino:{hp:400,spd:3,r:35,color:'#5e3a28',dmg:40,xp:80},
                hydra:{hp:4000,spd:1.5,r:70,color:'#2ecc71',dmg:50,xp:1000,boss:1,name:"Hidra Venenosa"},
                medusa:{hp:5000,spd:3.5,r:60,color:'#27ae60',dmg:60,xp:1500,boss:1,name:"Medusa Maldita"},
                herc:{hp:7000,spd:4.5,r:65,color:'#f39c12',dmg:80,xp:2000,boss:1,name:"H√©rcules"},
                ares:{hp:12000,spd:5.5,r:80,color:'#e74c3c',dmg:100,xp:5000,boss:1,name:"ARES"}
            },
            spawn(t,px,py) {
                let x,y,ok=false;
                if(px){ for(let i=0;i<20;i++){let a=Math.random()*6.28,d=i*10;x=px+Math.cos(a)*d;y=py+Math.sin(a)*d;if(!World.collide(x,y,80)){ok=true;break;}} }
                else { for(let i=0;i<10;i++){let a=Math.random()*6.28,d=500+Math.random()*500;x=Game.p.x+Math.cos(a)*d;y=Game.p.y+Math.sin(a)*d;if(!World.collide(x,y,30)){ok=true;break;}} }
                if(ok) this.l.push(new Enemy(this.types[t],x,y));
            },
            update() { this.l=this.l.filter(e=>!e.dead); this.l.forEach(e=>e.update()); if(!Game.bossOn && this.l.length<15+Game.diff) this.spawn('skel'); },
            draw(ctx) { this.l.forEach(e=>e.draw(ctx)); }
        };

        const Arts = {
            l: [],
            spawn(n) { for(let i=0;i<n;i++){ let ok=false,x,y; for(let k=0;k<20;k++){let a=Math.random()*6.28,d=400+Math.random()*1000;x=Game.p.x+Math.cos(a)*d;y=Game.p.y+Math.sin(a)*d;if(!World.collide(x,y,40)){ok=true;break;}} if(ok)this.l.push({x,y,ty:0}); } },
            update() {
                this.l.forEach(a=>{
                    a.ty+=0.1;
                    if(Math.hypot(Game.p.x-a.x,Game.p.y-a.y)<50) {
                        Game.arts++; Game.updArt(); Sound.play('art');
                        if(!Game.bossOn && Game.arts>=Game.nBoss) Game.spawnBoss();
                        a.dead=true;
                    }
                });
                this.l=this.l.filter(a=>!a.dead);
                if(!Game.bossOn && this.l.length<5) this.spawn(1);
            },
            draw(ctx) {
                ctx.fillStyle='#f1c40f'; ctx.shadowBlur=20; ctx.shadowColor='#f1c40f';
                this.l.forEach(a=>{ ctx.save(); ctx.translate(a.x,a.y+Math.sin(a.ty)*5); ctx.beginPath(); ctx.moveTo(-10,-10); ctx.lineTo(10,-10); ctx.lineTo(5,10); ctx.lineTo(-5,10); ctx.fill(); ctx.restore(); });
                ctx.shadowBlur=0;
            }
        };

        const Combat = {
            area(x,y,ang,rng,arc,dmg) {
                let h=0;
                Enemies.l.forEach(e=>{
                    if(Math.hypot(e.x-x,e.y-y)<rng+e.r) {
                        let dif=Math.atan2(e.y-y,e.x-x)-ang;
                        while(dif>Math.PI)dif-=Math.PI*2;while(dif<-Math.PI)dif+=Math.PI*2;
                        if(Math.abs(dif)<arc/2){ e.hit(dmg); h++; }
                    }
                });
                if(h>0) { Game.c+=h; Game.ct=100; document.getElementById('combo-text').style.opacity=1; document.getElementById('combo-text').innerText=Game.c+" HITS"; }
            },
            hitP(d) {
                if(Game.p.inv>0)return; if(Stats.reflect>0) d*=0.5;
                Game.p.hp-=d; Game.p.inv=30; Game.shake(20); Sound.play('hit');
                document.getElementById('hp-bar').style.width=(Game.p.hp/Stats.maxHp*100)+'%';
                if(Game.p.hp<=0) Game.over();
            }
        };

        const Part = {
            l: [],
            update() { this.l.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.l--;}); this.l=this.l.filter(p=>p.l>0); if(this.l.length>200)this.l.shift(); },
            draw(ctx) { this.l.forEach(p=>{ctx.fillStyle=p.c;ctx.fillRect(p.x,p.y,p.s,p.s);}); },
            explo(x,y,c,n) { for(let i=0;i<n;i++)this.l.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,l:20,c,s:4}); },
            bolt(x,y) { this.l.push({x,y:y-300,vx:0,vy:30,l:10,c:'#ff0',s:5}); },
            bullet(x,y,a,friend) { this.l.push({x,y,vx:Math.cos(a)*10,vy:Math.sin(a)*10,l:60,c:friend?'orange':'purple',s:8}); },
            puddle(x,y) { this.l.push({x,y,vx:0,vy:0,l:200,c:'#0f0',s:20}); } // Poison
        };

        const Vis = {
            blades: [], nums: [],
            blade(x,y,a,r,f,h) { this.blades.push({x,y,a,r,f,h,l:10,m:10}); },
            num(x,y,v) { this.nums.push({x,y,v,l:30}); },
            draw(ctx) {
                this.blades.forEach(b=>{
                    b.l--; let p=1-(b.l/b.m), s=b.f?-1:1;
                    ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.a);
                    ctx.shadowBlur=15; ctx.shadowColor=Stats.bladeColor; ctx.strokeStyle=Stats.bladeColor; ctx.lineWidth=b.h?8:5;
                    ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(b.r/2, b.r/3*s, b.r, Math.sin(p*s)*b.r*s); ctx.stroke(); ctx.restore();
                });
                this.blades=this.blades.filter(b=>b.l>0);
                
                ctx.font="bold 24px Arial"; ctx.textAlign="center";
                this.nums.forEach(n=>{
                    n.l--; ctx.fillStyle='#fff'; ctx.fillText(n.v,n.x,n.y-=(30-n.l));
                });
                this.nums=this.nums.filter(n=>n.l>0);
            }
        };

        const Game = {
            p:null, diff:1, xp:0, nxp:100, arts:0, bk:0, bossOn:0, nBoss:5, cam:{x:0,y:0,s:0}, c:0, ct:0, st:0,
            start() {
                Input.init(); Sound.init();
                this.p=new Player(); Enemies.l=[]; Arts.l=[]; Part.l=[]; this.st=Date.now();
                this.diff=1; this.xp=0; this.arts=0; this.bk=0; this.nBoss=5;
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('game-over-screen').classList.add('hidden');
                document.getElementById('end-screen').classList.add('hidden');
                this.updArt(); Arts.spawn(20);
                gameState='PLAY'; this.loop();
            },
            shake(a){this.cam.s=a;},
            updArt(){document.getElementById('artifact-ui').innerText=`Artefatos: ${this.arts}/${this.nBoss}`;},
            kill(e){
                this.xp+=e.t.xp; document.getElementById('xp-bar').style.width=(this.xp/this.nxp*100)+'%';
                if(this.xp>=this.nxp) { this.xp=0; this.nxp*=1.4; this.card(); }
                if(e.t.boss) {
                    this.bk++; this.bossOn=0; document.getElementById('boss-hud').style.display='none';
                    if(this.bk>=4) this.win(); else { this.diff+=2; this.nBoss+=5; this.updArt(); Arts.spawn(10); }
                }
            },
            spawnBoss(){
                this.bossOn=true;
                let t='hydra'; if(this.bk==1)t='medusa'; if(this.bk==2)t='herc'; if(this.bk==3)t='ares';
                Enemies.spawn(t, this.p.x+300, this.p.y);
                document.getElementById('boss-hud').style.display='block';
                document.getElementById('boss-name').innerText=Enemies.types[t].name;
            },
            card() {
                gameState='PAUSE';
                const d=document.getElementById('upgrade-cards'); d.innerHTML='';
                Upgrades.sort(()=>Math.random()-0.5).slice(0,3).forEach(u=>{
                    const c=document.createElement('div'); c.className='card';
                    c.innerHTML=`<div class="card-icon">${u.i}</div><h3>${u.t}</h3><p>${u.d}</p>`;
                    c.onclick=()=>{u.f(); document.getElementById('upgrade-screen').classList.add('hidden'); gameState='PLAY'; this.loop();};
                    d.appendChild(c);
                });
                document.getElementById('upgrade-screen').classList.remove('hidden');
            },
            loop() {
                if(gameState!='PLAY')return;
                this.p.update(); Enemies.update(); Arts.update(); Part.update();
                
                let tx=this.p.x-WIDTH/2, ty=this.p.y-HEIGHT/2;
                this.cam.x+=(tx-this.cam.x)*0.1; this.cam.y+=(ty-this.cam.y)*0.1;
                if(this.cam.s>0){this.cam.x+=(Math.random()-0.5)*this.cam.s;this.cam.y+=(Math.random()-0.5)*this.cam.s;this.cam.s*=0.9;}
                Input.updateWorld(this.cam.x, this.cam.y);

                if(this.bossOn) {
                    let b=Enemies.l.find(e=>e.t.boss);
                    if(b) document.getElementById('boss-hp').style.width=(b.hp/b.max*100)+'%';
                }
                if(this.ct>0)this.ct--; else { this.c=0; document.getElementById('combo-text').style.opacity=0; }
                
                let el=Math.floor((Date.now()-this.st)/1000);
                document.getElementById('timer').innerText=`${Math.floor(el/60)}:${(el%60).toString().padStart(2,'0')}`;

                ctx.fillStyle='#000'; ctx.fillRect(0,0,WIDTH,HEIGHT);
                World.draw(ctx, this.cam.x, this.cam.y);
                
                // Vignette
                const grd=ctx.createRadialGradient(WIDTH/2,HEIGHT/2,200,WIDTH/2,HEIGHT/2,800);
                grd.addColorStop(0,"rgba(0,0,0,0)"); grd.addColorStop(1,"rgba(0,0,0,0.8)");
                ctx.fillStyle=grd; ctx.fillRect(0,0,WIDTH,HEIGHT);

                ctx.save(); ctx.translate(-this.cam.x,-this.cam.y);
                Arts.draw(ctx); Part.draw(ctx); Enemies.draw(ctx); this.p.draw(ctx); Vis.draw(ctx);
                ctx.restore();

                requestAnimationFrame(()=>this.loop());
            },
            win() { gameState='WIN'; document.getElementById('end-screen').classList.remove('hidden'); },
            over() { gameState='OVER'; document.getElementById('game-over-screen').classList.remove('hidden'); }
        };
    </script>
</body>
</html>