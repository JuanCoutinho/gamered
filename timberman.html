<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timber Lite: Reforged</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --ui-bg: rgba(20, 20, 30, 0.95);
            --ui-border: #4a4a5a;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            touch-action: none;
            background-color: #1a1a2e;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Scanline effect for retro feel */
        body::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 100;
        }

        #game-canvas {
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
            /* Sharp pixels */
        }

        /* UI Overlay Styles */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.85);
            z-index: 20;
            transition: opacity 0.2s;
            backdrop-filter: blur(5px);
        }

        .hidden {
            display: none !important;
        }

        .btn {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            border: 4px solid #1c2a35;
            padding: 15px 20px;
            font-family: inherit;
            color: white;
            font-size: 0.8rem;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 6px 0 #1c2a35;
            transition: transform 0.1s, box-shadow 0.1s;
            text-shadow: 1px 1px 0 #000;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1c2a35;
        }

        .btn-green {
            background: linear-gradient(to bottom, #2ecc71, #27ae60);
        }

        .btn-red {
            background: linear-gradient(to bottom, #e74c3c, #c0392b);
        }

        .btn-purple {
            background: linear-gradient(to bottom, #9b59b6, #8e44ad);
        }

        .btn:disabled {
            filter: grayscale(1);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* HUD Styles */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
            box-sizing: border-box;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .bar-wrap {
            width: 120px;
            height: 16px;
            background: #2d3436;
            border: 2px solid #000;
            margin-top: 4px;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.1s linear;
        }

        /* Controls Hints */
        .tap-hint {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            opacity: 0.1;
            pointer-events: none;
            animation: pulse 1s infinite;
        }

        .tap-left {
            left: 20px;
        }

        .tap-right {
            right: 20px;
        }

        @keyframes pulse {
            0% {
                opacity: 0.1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 0.1;
            }
        }

        /* Card Styles */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            width: 90%;
            max-width: 800px;
        }

        .card {
            background: #fff;
            color: #333;
            border: 4px solid #333;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: scale(1.05) rotate(-1deg);
            border-color: #f1c40f;
            z-index: 5;
        }

        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #bdc3c7;
        }

        .card.rare {
            border-color: #9b59b6;
        }

        .card.rare::before {
            background: #9b59b6;
        }
    </style>
</head>

<body>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <!-- Esquerda: Energia -->
        <div class="hud-panel">
            <div class="text-[0.6rem] text-gray-300">ENERGIA (TEMPO)</div>
            <div class="bar-wrap">
                <div id="stamina-bar" class="bar-fill"
                    style="background: linear-gradient(90deg, #e74c3c, #c0392b); width: 100%;"></div>
            </div>
            <div id="gold-display" class="mt-2 text-yellow-400 text-xs">ü™ô 0</div>
        </div>

        <!-- Centro: Score -->
        <div class="text-center mt-2">
            <div id="score-display" class="text-3xl text-white drop-shadow-md font-bold">0</div>
            <div class="text-[0.5rem] text-gray-400">METROS</div>
        </div>

        <!-- Direita: XP -->
        <div class="hud-panel text-right">
            <div class="text-[0.6rem] text-gray-300">N√çVEL <span id="level-display" class="text-white">1</span></div>
            <div class="bar-wrap ml-auto">
                <div id="xp-bar" class="bar-fill"
                    style="background: linear-gradient(90deg, #2ecc71, #27ae60); width: 0%;"></div>
            </div>
            <div id="combo-display" class="mt-1 text-cyan-300 text-xs opacity-0 transition-opacity">COMBO x0</div>
        </div>
    </div>

    <!-- Dicas de Controle -->
    <div id="controls-hint" class="hidden">
        <div class="tap-hint tap-left">üëà</div>
        <div class="tap-hint tap-right">üëâ</div>
        <div
            style="position:absolute; bottom: 10%; width: 100%; text-align: center; color: rgba(255,255,255,0.5); font-size: 0.7rem;">
            TOQUE NOS LADOS PARA CORTAR
        </div>
    </div>

    <!-- CANVAS -->
    <canvas id="game-canvas"></canvas>

    <!-- MENU PRINCIPAL -->
    <div id="menu-screen" class="overlay">
        <div class="mb-6 text-center">
            <h1 class="text-5xl text-yellow-400 mb-2 pixel-text" style="text-shadow: 4px 4px #000;">TIMBER<br>ROGUE</h1>
            <p class="text-[0.6rem] text-gray-400 mt-2">VERS√ÉO 2.0</p>
        </div>

        <!-- Sele√ß√£o de Classe -->
        <div class="bg-gray-800 p-6 border-4 border-gray-600 mb-6 w-11/12 max-w-md relative shadow-xl">
            <div
                class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-900 px-2 text-xs text-green-400 border border-green-400">
                PERSONAGEM
            </div>

            <div class="flex justify-between items-center mb-4">
                <button id="prev-class" class="text-2xl p-2 hover:text-yellow-400">&lt;</button>
                <div id="class-info" class="text-center">
                    <div id="class-icon" class="text-4xl mb-2">ü™ì</div>
                    <div id="class-name" class="text-lg text-yellow-300 mb-1">LENHADOR</div>
                    <div id="class-desc" class="text-[0.55rem] text-gray-300 h-8 leading-relaxed">Balanceado.</div>
                </div>
                <button id="next-class" class="text-2xl p-2 hover:text-yellow-400">&gt;</button>
            </div>

            <div id="unlock-area" class="border-t border-gray-600 pt-2 mt-2 hidden">
                <p class="text-xs text-center text-red-400 mb-2">Bloqueado</p>
                <button id="buy-class-btn" class="btn btn-purple w-full py-2 text-xs">COMPRAR (500ü™ô)</button>
            </div>
        </div>

        <!-- Meta Progress√£o Simplificada -->
        <div class="flex gap-4 mb-8">
            <div class="text-center">
                <div class="text-yellow-400 text-xs mb-1">TOTAL ü™ô</div>
                <div id="meta-gold" class="text-white">0</div>
            </div>
            <button id="upgrade-stamina-btn" class="btn btn-sm py-2 px-3 text-[0.6rem]">
                UP STAMINA <br><span id="stamina-cost" class="text-yellow-200">200g</span>
            </button>
        </div>

        <button id="start-btn" class="btn btn-green text-xl w-64 animate-bounce">JOGAR</button>
    </div>

    <!-- LEVEL UP -->
    <div id="levelup-screen" class="overlay hidden">
        <h2 class="text-3xl text-yellow-400 mb-2 pixel-text text-shadow-md">LEVEL UP!</h2>
        <p class="text-[0.6rem] text-gray-300 mb-8">O tempo parou. Escolha seu destino.</p>
        <div id="cards-container" class="card-grid">
            <!-- Cards gerados via JS -->
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameover-screen" class="overlay hidden">
        <h2 class="text-4xl text-red-500 mb-2 pixel-text">MORT O</h2>
        <p id="death-reason" class="text-xs text-gray-300 mb-6 uppercase tracking-widest">Causa: Desconhecida</p>

        <div class="flex gap-8 text-center mb-8 bg-gray-900 p-4 border-2 border-gray-700">
            <div>
                <div class="text-[0.6rem] text-gray-500">DIST√ÇNCIA</div>
                <div id="final-score" class="text-xl text-white">0m</div>
            </div>
            <div>
                <div class="text-[0.6rem] text-gray-500">OURO</div>
                <div id="final-gold" class="text-xl text-yellow-400">0</div>
            </div>
        </div>

        <button id="restart-btn" class="btn btn-blue w-64">TENTAR DE NOVO</button>
    </div>

    <script>
        /** === CORE CONFIG === */
        const CANVAS = document.getElementById('game-canvas');
        const CTX = CANVAS.getContext('2d');

        function resizeCanvas() {
            // Manter aspect ratio mobile-friendly mas preencher a tela
            CANVAS.width = window.innerWidth;
            CANVAS.height = window.innerHeight;
            CTX.imageSmoothingEnabled = false; // Pixel art look
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        /** === DATA === */
        const CLASSES = [
            { id: 'lumberjack', name: 'LENHADOR', icon: 'ü™ì', desc: 'Cl√°ssico. Confi√°vel.', cost: 0, color: '#e67e22', skin: 'normal', stats: { damage: 1, decay: 1 } },
            { id: 'ninja', name: 'NINJA', icon: 'ü•∑', desc: 'R√°pido, mas fraco contra Ferro.', cost: 500, color: '#34495e', skin: 'ninja', stats: { damage: 0.8, decay: 0.7 } },
            { id: 'mage', name: 'MAGO', icon: 'üßô‚Äç‚ôÇÔ∏è', desc: 'Chance de destruir 3 blocos.', cost: 1000, color: '#8e44ad', skin: 'mage', stats: { damage: 1, decay: 1.1, magic: true } },
            { id: 'robot', name: 'MECHA', icon: 'ü§ñ', desc: 'Imune a Espinhos, mas lento.', cost: 2500, color: '#95a5a6', skin: 'robot', stats: { damage: 2, decay: 1.3, armored: true } }
        ];

        const BIOMES = [
            { score: 0, name: 'Floresta', skyTop: '#3498db', skyBot: '#81ecec', trunk: '#795548', bark: '#5d4037', leaf: '#2ecc71' },
            { score: 100, name: 'Ocaso', skyTop: '#2c3e50', skyBot: '#e67e22', trunk: '#d35400', bark: '#a04000', leaf: '#f1c40f' },
            { score: 250, name: 'Inverno', skyTop: '#bdc3c7', skyBot: '#ecf0f1', trunk: '#34495e', bark: '#2c3e50', leaf: '#dfe6e9' },
            { score: 500, name: 'Inferno', skyTop: '#2c3e50', skyBot: '#c0392b', trunk: '#4a0000', bark: '#2c0000', leaf: '#e74c3c' }
        ];

        const UPGRADES = [
            { id: 'sharp', name: 'Afiador', desc: 'Dano +20%', rarity: 'common', apply: (s) => s.damageMult += 0.2 },
            { id: 'lungs', name: 'Aer√≥bico', desc: 'Recupera +Stamina', rarity: 'common', apply: (s) => s.staminaGainMult += 0.2 },
            { id: 'gold', name: 'Garimpeiro', desc: 'Ouro +50%', rarity: 'common', apply: (s) => s.goldMult += 0.5 },
            { id: 'freeze', name: 'Crono-Parada', desc: 'Trava tempo a cada 50 hits', rarity: 'rare', apply: (s) => s.hasTimeFreeze = true },
            { id: 'fire', name: 'L√¢mina de Fogo', desc: 'Queima blocos acima', rarity: 'rare', apply: (s) => s.hasFireAxe = true },
            { id: 'ghost', name: 'Fantasma', desc: '50% chance de ignorar galho', rarity: 'rare', apply: (s) => s.dodgeChance = 0.5 }
        ];

        /** === STATE === */
        let state = {
            screen: 'MENU',
            player: { classId: 'lumberjack', side: -1, state: 'idle', animFrame: 0, yOffset: 0 },
            stats: { score: 0, xp: 0, nextXp: 20, level: 1, gold: 0, stamina: 100, maxStamina: 100, combo: 0 },
            mods: { damageMult: 1, staminaGainMult: 1, goldMult: 1, hasTimeFreeze: false, hasFireAxe: false, dodgeChance: 0 },
            tree: [],
            flyingLogs: [], // Array para peda√ßos de madeira voando
            particles: [],
            popups: [],
            shake: 0,
            flash: 0,
            lastTime: 0,
            meta: loadMeta()
        };

        function loadMeta() {
            return {
                gold: parseInt(localStorage.getItem('tr_gold') || 0),
                unlocked: JSON.parse(localStorage.getItem('tr_unlocked') || '["lumberjack"]'),
                staminaLvl: parseInt(localStorage.getItem('tr_stamina_lvl') || 0)
            };
        }

        function saveMeta() {
            localStorage.setItem('tr_gold', state.meta.gold);
            localStorage.setItem('tr_unlocked', JSON.stringify(state.meta.unlocked));
            localStorage.setItem('tr_stamina_lvl', state.meta.staminaLvl);
        }

        /** === AUDIO (Sintetizado para evitar assets externos) === */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playTone(freq, type, duration, vol = 0.1) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function sfx(name) {
            switch (name) {
                case 'chop': playTone(100 + Math.random() * 50, 'square', 0.1); break;
                case 'iron': playTone(400, 'sawtooth', 0.2); break;
                case 'levelup':
                    playTone(400, 'sine', 0.5);
                    setTimeout(() => playTone(600, 'sine', 0.5), 100);
                    setTimeout(() => playTone(800, 'sine', 0.8), 200);
                    break;
                case 'die': playTone(100, 'sawtooth', 0.5, 0.3); break;
            }
        }

        /** === GAMEPLAY LOGIC === */
        function initGame() {
            const cls = CLASSES.find(c => c.id === state.player.classId);
            state.stats = {
                score: 0, xp: 0, nextXp: 20, level: 1, gold: 0,
                maxStamina: 100 + (state.meta.staminaLvl * 10),
                stamina: 100 + (state.meta.staminaLvl * 10),
                combo: 0
            };
            state.mods = { damageMult: cls.stats.damage, staminaGainMult: 1, goldMult: 1, hasTimeFreeze: false, hasFireAxe: false, dodgeChance: 0 };
            if (cls.stats.magic) state.mods.magic = true;
            if (cls.stats.armored) state.mods.armored = true;
            state.mods.decayMod = cls.stats.decay;

            state.tree = [];
            for (let i = 0; i < 12; i++) addLog(i === 0); // Primeiro segmento seguro

            state.player.side = -1;
            state.player.state = 'idle';
            state.flyingLogs = [];
            state.particles = [];
            state.popups = [];
            state.screen = 'PLAYING';
            state.flash = 0;

            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('controls-hint').classList.remove('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('gameover-screen').classList.add('hidden');

            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        function addLog(safe = false) {
            const score = state.stats.score;
            let type = 'normal';
            let hp = 1;

            // Dificuldade Progressiva
            const ironChance = Math.min(0.2, score * 0.0005);
            if (!safe && score > 30 && Math.random() < ironChance) {
                type = 'iron';
                hp = 2;
            } else if (!safe && Math.random() < 0.05) {
                type = 'gold';
            }

            let branch = 'none';
            if (!safe) {
                // Previne galhos imposs√≠veis (sequ√™ncia de esquerda-direita muito r√°pida)
                // L√≥gica simples: aleat√≥rio
                const r = Math.random();
                if (r < 0.25) branch = 'left';
                else if (r > 0.75) branch = 'right';
            }

            state.tree.push({ type, hp, maxHp: hp, branch, animY: 0 });
        }

        function chop(side) {
            if (state.screen !== 'PLAYING') return;

            // Update Player
            state.player.side = side;
            state.player.state = 'chop';
            state.player.animFrame = 5;
            state.player.yOffset = 5; // Squash effect

            // Esconde dicas ap√≥s primeiro movimento
            document.getElementById('controls-hint').classList.add('hidden');

            const currentLog = state.tree[0];
            const nextLog = state.tree[1];

            // 1. CHECAR MORTE (Galho na cabe√ßa)
            // Se o galho do bloco DE CIMA (index 1) estiver no lado que eu bati, ele desce e me mata.
            if (nextLog && nextLog.branch === (side === -1 ? 'left' : 'right')) {
                // Chance de Esquiva
                if (Math.random() < state.mods.dodgeChance) {
                    popup("ESQUIVA!", 0, -50, '#3498db');
                } else if (state.mods.armored) {
                    popup("BLOCKED!", 0, -50, '#95a5a6');
                    sfx('iron');
                } else {
                    die("Esmagado por um galho");
                    return;
                }
            }

            // 2. DANO
            let damage = 1 * state.mods.damageMult;
            if (currentLog.type === 'iron') damage *= 0.6; // Ferro √© duro

            currentLog.hp -= damage;

            // Efeitos
            state.shake = 2;
            if (currentLog.hp <= 0) {
                // Destruiu
                breakLog(side, currentLog);
            } else {
                // Bateu mas n√£o quebrou
                sfx('iron');
                state.shake = 5;
                spawnParticles(side, 'spark');
            }
        }

        function breakLog(side, log) {
            sfx('chop');

            // Criar tronco voando (Visual importante)
            state.flyingLogs.push({
                type: log.type,
                branch: log.branch,
                x: CANVAS.width / 2,
                y: CANVAS.height - 120,
                vx: (side === -1 ? 1 : -1) * (10 + Math.random() * 5), // Voa pro lado oposto
                vy: -10 - Math.random() * 5,
                rot: 0,
                vRot: (Math.random() - 0.5) * 0.5,
                color: getLogColor(log.type)
            });

            // Remover da √°rvore e adicionar novo
            state.tree.shift();
            addTreeSegmentEffect(log);

            // Recompensa
            state.stats.score++;
            state.stats.xp += (log.type === 'gold' ? 5 : 1) * (1 + state.stats.combo * 0.1);
            state.stats.combo++;

            // Stamina
            let stamGain = 5 * state.mods.staminaGainMult;
            state.stats.stamina = Math.min(state.stats.maxStamina, state.stats.stamina + stamGain);

            // Gold
            if (log.type === 'gold' || Math.random() < 0.05 * state.mods.goldMult) {
                let g = Math.floor(5 * state.mods.goldMult);
                state.stats.gold += g;
                popup(`+${g}ü™ô`, 0, -80, '#f1c40f');
            }

            // Poderes Especiais
            if (state.mods.magic && Math.random() < 0.1) {
                // Magia destr√≥i +2 blocos
                state.tree.shift();
                state.tree.shift();
                addLog(); addLog();
                state.stats.score += 2;
                state.flash = 10;
                sfx('levelup'); // som m√°gico
                popup("MAGIC!", 0, -100, '#8e44ad');
            }

            // Repor √°rvore
            addLog();

            // Level Up Check
            if (state.stats.xp >= state.stats.nextXp) {
                startLevelUp();
            }

            // Mostrar Combo
            const comboEl = document.getElementById('combo-display');
            if (state.stats.combo > 5) {
                comboEl.innerText = `COMBO x${state.stats.combo}`;
                comboEl.style.opacity = 1;
            }
            updateHUD();
        }

        function addTreeSegmentEffect(oldLog) {
            // Anima√ß√£o de todos os blocos descendo
            state.tree.forEach(seg => seg.animY = -60);
        }

        function die(reason) {
            state.screen = 'GAMEOVER';
            state.flash = 20;
            state.shake = 20;
            sfx('die');

            document.getElementById('death-reason').innerText = `CAUSA: ${reason}`;
            document.getElementById('final-score').innerText = state.stats.score + "m";
            document.getElementById('final-gold').innerText = state.stats.gold;

            state.meta.gold += state.stats.gold;
            saveMeta();

            document.getElementById('gameover-screen').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
        }

        /** === RENDERING PROCEDURAL (A M√°gica Visual) === */

        function getBiome() {
            for (let i = BIOMES.length - 1; i >= 0; i--) {
                if (state.stats.score >= BIOMES[i].score) return BIOMES[i];
            }
            return BIOMES[0];
        }

        function getLogColor(type) {
            const b = getBiome();
            if (type === 'iron') return '#7f8c8d';
            if (type === 'gold') return '#f1c40f';
            return b.trunk;
        }

        function drawRect(x, y, w, h, color) {
            CTX.fillStyle = color;
            CTX.fillRect(Math.floor(x), Math.floor(y), Math.floor(w), Math.floor(h));
        }

        function drawPixelLog(x, y, w, h, log, biome) {
            // Base
            let baseColor = biome.trunk;
            let darkColor = biome.bark;

            if (log.type === 'iron') { baseColor = '#95a5a6'; darkColor = '#7f8c8d'; }
            if (log.type === 'gold') { baseColor = '#f1c40f'; darkColor = '#f39c12'; }

            // Gradient effect using lines
            drawRect(x, y, w, h, darkColor); // Back
            drawRect(x + 5, y, w - 10, h, baseColor); // Front highlights

            // Texture details (Bark lines)
            CTX.fillStyle = 'rgba(0,0,0,0.2)';
            for (let i = 0; i < 3; i++) {
                drawRect(x + 10 + i * 20, y + (log.type === 'iron' ? 5 : 10), 4, h - 20, 'rgba(0,0,0,0.1)');
            }

            // Iron Rivets
            if (log.type === 'iron') {
                CTX.fillStyle = '#bdc3c7';
                drawRect(x + 5, y + 5, 5, 5, '#fff');
                drawRect(x + w - 10, y + 5, 5, 5, '#fff');
                drawRect(x + 5, y + h - 10, 5, 5, '#fff');
                drawRect(x + w - 10, y + h - 10, 5, 5, '#fff');
            }

            // Branch
            if (log.branch !== 'none') {
                const bx = log.branch === 'left' ? x - 60 : x + w;
                const by = y + 20;

                // Branch Wood
                drawRect(bx, by, 60, 20, darkColor);

                // Leaves / Spikes
                CTX.fillStyle = biome.leaf;
                if (log.branch === 'left') {
                    drawRect(bx - 10, by - 10, 30, 40, biome.leaf); // Folhagem
                } else {
                    drawRect(bx + 40, by - 10, 30, 40, biome.leaf);
                }
            }

            // Crack effect if damaged
            if (log.hp < log.maxHp) {
                CTX.fillStyle = '#000';
                CTX.beginPath();
                CTX.moveTo(x + w / 2, y + h / 2);
                CTX.lineTo(x + w / 2 - 10, y + h / 2 + 10);
                CTX.stroke();
            }
        }

        function drawPlayer(x, y, cls) {
            // Sombra
            CTX.fillStyle = 'rgba(0,0,0,0.3)';
            CTX.beginPath();
            CTX.ellipse(x + 20, y + 55, 20, 5, 0, 0, Math.PI * 2);
            CTX.fill();

            // Squash & Stretch
            let sy = state.player.yOffset;
            let h = 50 - sy;
            let py = y + sy;

            // Body
            drawRect(x, py, 40, h, cls.color);

            // Headband / Details
            if (cls.skin === 'ninja') {
                drawRect(x, py + 5, 40, 10, '#c0392b'); // Red headband
            }
            if (cls.skin === 'mage') {
                drawRect(x, py - 10, 40, 10, '#8e44ad'); // Hat base
                drawRect(x + 10, py - 25, 20, 15, '#8e44ad'); // Hat top
            }

            // Eyes (Olhando pro tronco)
            CTX.fillStyle = 'white';
            let lookDir = state.player.side === -1 ? 20 : 0;
            drawRect(x + 10 + (state.player.side === -1 ? 10 : -10), py + 15, 8, 8, '#fff');
            drawRect(x + 25 + (state.player.side === -1 ? 10 : -10), py + 15, 8, 8, '#fff');

            // Axe
            CTX.save();
            CTX.translate(x + 20, py + 25);

            // Animation Swing
            let rot = 0;
            if (state.player.animFrame > 0) {
                rot = state.player.side === -1 ? -1 : 1;
            }
            CTX.rotate(rot);

            // Handle
            CTX.fillStyle = '#7f8c8d';
            drawRect(state.player.side === -1 ? 10 : -20, -10, 10, 40, '#a0522d');

            // Blade
            CTX.fillStyle = state.mods.hasFireAxe ? '#e74c3c' : '#bdc3c7';
            if (state.player.side === -1) {
                drawRect(20, -15, 20, 30, CTX.fillStyle);
            } else {
                drawRect(-40, -15, 20, 30, CTX.fillStyle);
            }
            CTX.restore();
        }

        function gameLoop(timestamp) {
            if (state.screen === 'MENU') {
                renderMenuBG();
                return;
            }
            if (state.screen === 'GAMEOVER') {
                // Keep drawing last frame but static
                return;
            }

            let dt = (timestamp - state.lastTime) / 1000;
            state.lastTime = timestamp;

            // Logic Update
            if (state.screen === 'PLAYING' && state.screen !== 'LEVEL_UP') {
                // Stamina Decay
                let decay = 12 * dt * state.mods.decayMod; // Aumentei um pouco a dificuldade base
                state.stats.stamina -= decay;
                if (state.stats.stamina <= 0) die("Exaust√£o");

                // Reset Combo
                if (state.player.state === 'idle' && state.stats.combo > 0) {
                    // Logic to decay combo? For now keep it simple
                }
            }

            // Animation Update
            if (state.player.animFrame > 0) state.player.animFrame--;
            if (state.player.yOffset > 0) state.player.yOffset -= 1;

            // Tree Animation
            state.tree.forEach(log => {
                if (log.animY < 0) log.animY += 10; // Drop effect
            });

            // Flying Logs Physics
            state.flyingLogs.forEach(log => {
                log.x += log.vx;
                log.y += log.vy;
                log.vy += 0.8; // Gravity
                log.rot += log.vRot;
            });
            // Cleanup offscreen logs
            state.flyingLogs = state.flyingLogs.filter(l => l.y < CANVAS.height + 100);

            // Popups
            state.popups.forEach(p => { p.y -= 1; p.life -= 0.02; });
            state.popups = state.popups.filter(p => p.life > 0);

            // Drawing
            draw(dt);

            requestAnimationFrame(gameLoop);
        }

        function draw(dt) {
            const biome = getBiome();
            const cx = CANVAS.width / 2;
            const cy = CANVAS.height - 150; // Ground Level

            // 1. Sky Gradient
            let grad = CTX.createLinearGradient(0, 0, 0, CANVAS.height);
            grad.addColorStop(0, biome.skyTop);
            grad.addColorStop(1, biome.skyBot);
            CTX.fillStyle = grad;
            CTX.fillRect(0, 0, CANVAS.width, CANVAS.height);

            // 2. Shake
            CTX.save();
            if (state.shake > 0) {
                let dx = (Math.random() - 0.5) * state.shake;
                let dy = (Math.random() - 0.5) * state.shake;
                CTX.translate(dx, dy);
                state.shake *= 0.9;
                if (state.shake < 0.5) state.shake = 0;
            }

            // 3. Ground
            CTX.fillStyle = '#2c3e50';
            CTX.fillRect(0, cy + 50, CANVAS.width, CANVAS.height - cy);
            // Grass top
            CTX.fillStyle = biome.leaf; // Use leaf color for grass
            CTX.fillRect(0, cy + 50, CANVAS.width, 10);

            // 4. Player
            const pClass = CLASSES.find(c => c.id === state.player.classId);
            const px = state.player.side === -1 ? cx - 100 : cx + 60;
            drawPlayer(px, cy - 10, pClass);

            // 5. Tree
            const logW = 80;
            const logH = 60;

            // Base Stump
            drawRect(cx - logW / 2 - 5, cy + 50, logW + 10, 20, '#3e2723');

            for (let i = 0; i < state.tree.length; i++) {
                const log = state.tree[i];
                const y = cy - (i * logH) + 50 + log.animY; // +50 align to ground

                // Only draw if visible
                if (y < -100) continue;

                drawPixelLog(cx - logW / 2, y - logH, logW, logH, log, biome);
            }

            // 6. Flying Logs
            state.flyingLogs.forEach(log => {
                CTX.save();
                CTX.translate(log.x, log.y);
                CTX.rotate(log.rot);
                drawRect(-40, -30, 80, 60, log.color);
                CTX.fillStyle = 'rgba(0,0,0,0.2)'; // Detail
                drawRect(-30, -30, 10, 60, null);
                CTX.restore();
            });

            // 7. Flash
            if (state.flash > 0) {
                CTX.fillStyle = `rgba(255,255,255,${state.flash / 20})`;
                CTX.fillRect(-10, -10, CANVAS.width + 20, CANVAS.height + 20);
                state.flash--;
            }

            // 8. Popups
            state.popups.forEach(p => {
                CTX.globalAlpha = Math.max(0, p.life);
                CTX.font = '16px "Press Start 2P"';
                CTX.fillStyle = 'black';
                CTX.fillText(p.text, p.x + 2, p.y + 2); // shadow
                CTX.fillStyle = p.color;
                CTX.fillText(p.text, p.x, p.y);
                CTX.globalAlpha = 1;
            });

            CTX.restore();
        }

        function spawnParticles(side, type) {
            // Placeholder for simple particle spawn if needed logic inside loop
            // Currently handled implicitly or not critical for V2 MVP
        }

        function popup(text, dx, dy, color) {
            state.popups.push({ text, x: CANVAS.width / 2 + dx, y: CANVAS.height / 2 + dy, color, life: 1.5 });
        }

        /** === UI LOGIC === */

        function updateHUD() {
            const stamPct = (state.stats.stamina / state.stats.maxStamina) * 100;
            const xpPct = (state.stats.xp / state.stats.nextXp) * 100;

            document.getElementById('stamina-bar').style.width = `${Math.max(0, stamPct)}%`;
            document.getElementById('xp-bar').style.width = `${Math.min(100, xpPct)}%`;
            document.getElementById('score-display').innerText = state.stats.score;
            document.getElementById('gold-display').innerText = `ü™ô ${state.stats.gold}`;
            document.getElementById('level-display').innerText = state.stats.level;

            // Combo fade
            const c = document.getElementById('combo-display');
            if (state.stats.combo < 1) c.style.opacity = 0;
        }

        /* MENU LOGIC */
        let currClassIdx = 0;
        function updateClassUI() {
            const c = CLASSES[currClassIdx];
            document.getElementById('class-icon').innerText = c.icon;
            document.getElementById('class-name').innerText = c.name;
            document.getElementById('class-desc').innerText = c.desc;
            document.getElementById('class-name').style.color = c.color;

            const unlocked = state.meta.unlocked.includes(c.id);
            const btn = document.getElementById('start-btn');
            const unlockArea = document.getElementById('unlock-area');

            if (unlocked) {
                btn.disabled = false;
                btn.innerText = "JOGAR";
                unlockArea.classList.add('hidden');
                state.player.classId = c.id;
            } else {
                btn.disabled = true;
                btn.innerText = "BLOQUEADO";
                unlockArea.classList.remove('hidden');
                const buyBtn = document.getElementById('buy-class-btn');
                buyBtn.innerText = `COMPRAR (${c.cost}ü™ô)`;
                buyBtn.disabled = state.meta.gold < c.cost;
                buyBtn.onclick = () => {
                    if (state.meta.gold >= c.cost) {
                        state.meta.gold -= c.cost;
                        state.meta.unlocked.push(c.id);
                        saveMeta();
                        updateClassUI();
                        updateMetaUI();
                    }
                };
            }
        }

        document.getElementById('prev-class').onclick = () => {
            currClassIdx = (currClassIdx - 1 + CLASSES.length) % CLASSES.length;
            updateClassUI();
        }
        document.getElementById('next-class').onclick = () => {
            currClassIdx = (currClassIdx + 1) % CLASSES.length;
            updateClassUI();
        }

        function updateMetaUI() {
            document.getElementById('meta-gold').innerText = state.meta.gold;
            const cost = 200 * (state.meta.staminaLvl + 1);
            const btn = document.getElementById('upgrade-stamina-btn');
            document.getElementById('stamina-cost').innerText = `${cost}g`;
            btn.onclick = () => {
                if (state.meta.gold >= cost) {
                    state.meta.gold -= cost;
                    state.meta.staminaLvl++;
                    saveMeta();
                    updateMetaUI();
                }
            }
        }

        document.getElementById('start-btn').onclick = initGame;
        document.getElementById('restart-btn').onclick = () => {
            state.screen = 'MENU';
            document.getElementById('gameover-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            renderMenuBG();
        };

        // Level Up Logic
        function startLevelUp() {
            state.screen = 'LEVEL_UP';
            sfx('levelup');
            const container = document.getElementById('cards-container');
            container.innerHTML = '';

            // Get 3 random cards
            let pool = [...UPGRADES];
            for (let i = 0; i < 3; i++) {
                if (pool.length === 0) break;
                const idx = Math.floor(Math.random() * pool.length);
                const card = pool.splice(idx, 1)[0];

                const div = document.createElement('div');
                div.className = `card ${card.rarity}`;
                div.innerHTML = `
                    <div class="text-xs font-bold mb-1" style="color:${card.rarity === 'rare' ? '#9b59b6' : '#333'}">${card.name}</div>
                    <div class="text-[0.6rem] text-gray-600">${card.desc}</div>
                `;
                div.onclick = () => {
                    card.apply(state.mods);
                    state.stats.xp -= state.stats.nextXp;
                    state.stats.nextXp = Math.floor(state.stats.nextXp * 1.5);
                    state.stats.level++;
                    state.screen = 'PLAYING';
                    document.getElementById('levelup-screen').classList.add('hidden');
                    popup("POWER UP!", 0, 0, '#fff');
                };
                container.appendChild(div);
            }
            document.getElementById('levelup-screen').classList.remove('hidden');
        }

        // Render Simple Menu BG
        function renderMenuBG() {
            CTX.fillStyle = '#1a1a2e';
            CTX.fillRect(0, 0, CANVAS.width, CANVAS.height);
            // Draw big logo tree
            drawPixelLog(CANVAS.width / 2 - 40, CANVAS.height / 2 - 50, 80, 100, { type: 'normal', branch: 'none' }, BIOMES[0]);
        }

        // Inputs
        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') chop(-1);
            if (e.key === 'ArrowRight') chop(1);
        });

        CANVAS.addEventListener('touchstart', e => {
            e.preventDefault();
            const x = e.touches[0].clientX;
            if (x < window.innerWidth / 2) chop(-1);
            else chop(1);
        }, { passive: false });

        CANVAS.addEventListener('mousedown', e => {
            const x = e.clientX;
            if (x < window.innerWidth / 2) chop(-1);
            else chop(1);
        });

        // Init
        updateClassUI();
        updateMetaUI();
        renderMenuBG();

    </script>
</body>

</html>