<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Espresso Dungeon: Reforged</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-dark: #0f0e11;
            --bg-panel: #2a262b;
            --accent-gold: #fbbf24;
            --border-light: #52525b;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background-color: #000;
            color: #e5e7eb;
            overflow: hidden;
            touch-action: none;
            image-rendering: pixelated;
            /* Garante altura total em mobile browsers modernos */
            height: 100dvh;
            width: 100vw;
        }

        /* --- CRT EFFECT (Ajustado para ser menos intrusivo) --- */
        .scanlines {
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom, rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
        }
        
        /* Borda Pixelada grossa */
        .pixel-border {
            box-shadow: 
                -4px 0 0 0 #000,
                4px 0 0 0 #000,
                0 -4px 0 0 #000,
                0 4px 0 0 #000;
            margin: 4px;
        }

        /* Anima√ß√µes */
        .monster-bounce { animation: bounce 2s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        .float-text {
            animation: floatUp 0.8s forwards ease-out;
            position: absolute;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0 #000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.5); opacity: 0; }
        }

        .ghost-item {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.9;
            transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }

        /* UI Improvements */
        .card-slot {
            background: #18181b;
            border: 2px solid #3f3f46;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        
        .bubble-tail::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center bg-gray-900">

    <div class="scanlines"></div>

    <!-- MAIN APP CONTAINER -->
    <div id="game-container" class="relative w-full h-full max-w-md bg-[#1a1a1a] flex flex-col shadow-2xl overflow-hidden border-x-0 md:border-x-4 border-gray-800">

        <!-- HEADER (Com safe area padding para mobile) -->
        <header class="h-16 pt-2 bg-[#262626] border-b-4 border-black flex items-center justify-between px-4 z-20 shrink-0 shadow-lg">
            <div class="flex flex-col">
                <span class="text-[8px] text-gray-400 mb-1">VIDA</span>
                <div class="flex gap-1 text-red-500 text-xl" id="hearts-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>
            
            <div class="flex flex-col items-center justify-center bg-black/30 px-4 py-1 rounded border border-gray-700">
                <span class="text-[#fbbf24] text-[8px] mb-1">DIA</span>
                <span id="day-display" class="text-xl text-white font-bold leading-none">1</span>
            </div>

            <div class="flex flex-col items-end">
                <span class="text-[8px] text-gray-400 mb-1">OURO</span>
                <div class="text-[#fbbf24] text-xl tracking-tighter drop-shadow-sm">$<span id="gold-display">0</span></div>
            </div>
        </header>

        <!-- GAME AREA -->
        <main class="flex-1 relative flex flex-col w-full overflow-hidden">
            
            <!-- 1. DUNGEON ZONE (Ocupa o espa√ßo restante) -->
            <div id="dungeon-zone" class="flex-1 bg-[#121212] relative w-full overflow-hidden border-b-4 border-black flex flex-col justify-end">
                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-10" 
                     style="background-image: radial-gradient(#4a4a4a 1px, transparent 1px); background-size: 20px 20px;">
                </div>
                
                <!-- Monsters Spawn Row -->
                <div id="monster-row" class="w-full flex justify-center items-end gap-2 pb-4 px-2 min-h-[200px] z-10 pointer-events-none">
                    <!-- Monsters Injected via JS -->
                </div>
            </div>

            <!-- 2. WORKSTATION (Altura fixa, ancorada embaixo) -->
            <div class="h-auto bg-[#262626] relative flex flex-col shrink-0 pb-safe z-30 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
                
                <!-- Bancada Superior -->
                <div class="h-6 bg-[#3f3f46] border-y-4 border-[#18181b] w-full relative"></div>

                <div class="flex flex-col gap-2 p-2 pb-6">
                    
                    <!-- Linha de A√ß√£o: Lixo e Caldeir√£o -->
                    <div class="flex justify-between items-end px-4 -mt-16 mb-2">
                        
                        <!-- TRASH (Mais discreto) -->
                        <div id="trash-zone" class="w-16 h-16 bg-[#18181b] border-2 border-red-900/50 rounded flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all z-20 shadow-lg">
                            <span class="text-2xl">üóëÔ∏è</span>
                        </div>

                        <!-- CAULDRON (Hero Item - Centralizado e Grande) -->
                        <div id="cauldron-zone" class="relative w-36 h-36 z-30 transition-transform active:scale-95 touch-manipulation">
                            <!-- Glow Effect Behind -->
                            <div class="absolute inset-0 bg-purple-500/20 blur-xl rounded-full animate-pulse"></div>
                            
                            <!-- SVG Graphic -->
                            <svg class="w-full h-full drop-shadow-[0_10px_10px_rgba(0,0,0,0.8)]" viewBox="0 0 100 100" fill="none">
                                <!-- Back Legs -->
                                <path d="M25 90 L20 98 M75 90 L80 98" stroke="#333" stroke-width="6" stroke-linecap="round"/>
                                <!-- Pot Body -->
                                <path d="M10 35 Q10 10 30 10 L70 10 Q90 10 90 35 L85 85 Q85 95 50 95 Q15 95 15 85 Z" fill="#2d2a2e" stroke="#52525b" stroke-width="3"/>
                                <!-- Rim -->
                                <path d="M8 35 L92 35" stroke="#71717a" stroke-width="4" stroke-linecap="round"/>
                                <!-- Shine -->
                                <path d="M20 40 Q20 80 30 85" stroke="rgba(255,255,255,0.1)" stroke-width="3" fill="none"/>
                            </svg>
                            
                            <!-- Liquid Mask -->
                            <div class="absolute top-[35%] left-[18%] w-[64%] h-[55%] overflow-hidden rounded-b-[40px] opacity-90 pointer-events-none">
                                <div id="cauldron-liquid" class="w-full bg-purple-600 absolute bottom-0 transition-all duration-300 border-t-4 border-purple-400/50" style="height: 0%"></div>
                                <!-- Bubbles -->
                                <div id="cauldron-bubbles" class="absolute inset-0 hidden">
                                    <div class="absolute bottom-0 left-1/3 w-3 h-3 bg-white/40 rounded-full animate-[bounce_2s_infinite]"></div>
                                    <div class="absolute bottom-2 left-2/3 w-2 h-2 bg-white/40 rounded-full animate-[bounce_1.5s_infinite_0.5s]"></div>
                                </div>
                            </div>

                            <!-- Contents Preview -->
                            <div id="cauldron-stack" class="absolute top-4 left-0 w-full h-full flex items-center justify-center pointer-events-none z-40">
                                <!-- Icons added by JS -->
                            </div>

                            <div class="absolute -bottom-2 w-full text-center text-[8px] text-yellow-500/80 font-bold tracking-widest uppercase bg-black/50 py-1 rounded">Misturar</div>
                        </div>

                        <!-- Spacer for symmetry if needed, or maybe a "Serve" hint arrow -->
                        <div class="w-16 flex justify-center items-center opacity-30">
                            <span class="text-2xl">‚ûî</span>
                        </div>
                    </div>

                    <!-- DECK ZONE (Cartas Maiores) -->
                    <div id="deck-zone" class="h-28 w-full card-slot rounded-lg p-2 flex gap-3 items-center overflow-x-auto touch-pan-x">
                        <!-- Cards injected here -->
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- OVERLAYS (Full Screen) -->
    
    <!-- START SCREEN -->
    <div id="screen-start" class="fixed inset-0 bg-[#0f0e11] z-50 flex flex-col items-center justify-center text-center p-6">
        <h1 class="text-3xl md:text-5xl text-[#fbbf24] mb-8 leading-snug drop-shadow-[4px_4px_0_#000]">ESPRESSO<br>DUNGEON</h1>
        
        <div class="bg-[#1a1a1a] border-2 border-[#3f3f46] p-6 max-w-sm w-full mb-8 text-left space-y-4 shadow-lg">
            <div class="flex items-center gap-4">
                <span class="text-2xl">‚òï</span>
                <p class="text-[10px] text-gray-300 leading-4">Arraste ingredientes para o <strong>Caldeir√£o</strong>.</p>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl">üëπ</span>
                <p class="text-[10px] text-gray-300 leading-4">Arraste o <strong>Caldeir√£o</strong> para os monstros.</p>
            </div>
        </div>

        <button onclick="Game.init()" class="bg-[#fbbf24] text-black border-b-4 border-r-4 border-yellow-700 active:border-0 active:translate-y-1 px-8 py-4 text-sm font-bold transition-all">
            ABRIR TAVERNA
        </button>
    </div>

    <!-- SHOP SCREEN -->
    <div id="screen-shop" class="fixed inset-0 bg-[#0f0e11] z-50 hidden flex flex-col p-4 animate-fade-in">
        <div class="text-center py-6">
            <h2 class="text-2xl text-[#fbbf24] mb-2">MERCADOR</h2>
            <p class="text-[10px] text-gray-500">Prepare-se para amanh√£</p>
        </div>
        
        <div id="shop-container" class="flex-1 flex flex-col gap-3 overflow-y-auto px-2 pb-20">
            <!-- Cards Generated Here -->
        </div>
        
        <div class="fixed bottom-0 left-0 w-full bg-[#1a1a1a] border-t border-gray-800 p-4 flex justify-between items-center">
            <div class="text-yellow-400 text-sm">Ouro: $<span id="shop-gold">0</span></div>
            <button onclick="Game.closeShop()" class="bg-green-700 text-white px-4 py-2 text-xs border-b-2 border-green-900 active:border-0">
                PR√ìXIMO DIA >
            </button>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="screen-gameover" class="fixed inset-0 bg-red-950/95 z-50 hidden flex flex-col items-center justify-center text-center p-6">
        <div class="text-8xl mb-6 animate-bounce">üíÄ</div>
        <h2 class="text-3xl text-white mb-2">FIM DE JOGO</h2>
        <p class="text-xs text-red-200 mb-8 max-w-[200px]">Os monstros destru√≠ram sua cafeteria.</p>
        <div class="bg-black/50 p-4 rounded mb-8">
            <p class="text-sm text-yellow-400">Dias Sobrevividos: <span id="final-score" class="text-white text-xl block mt-2">0</span></p>
        </div>
        <button onclick="location.reload()" class="bg-white text-black px-6 py-4 text-xs font-bold border-b-4 border-gray-400 active:translate-y-1 active:border-0">
            TENTAR NOVAMENTE
        </button>
    </div>

    <!-- AUDIO SYSTEM -->
    <script>
        const AudioSys = {
            ctx: null,
            init: function() {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration, vol = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            sfx: {
                pickup: () => AudioSys.playTone(300, 'triangle', 0.1, 0.1),
                drop: () => AudioSys.playTone(200, 'sine', 0.1, 0.1),
                trash: () => AudioSys.playTone(100, 'sawtooth', 0.2, 0.1),
                serve: () => {
                    AudioSys.playTone(600, 'square', 0.1, 0.1);
                    setTimeout(() => AudioSys.playTone(900, 'square', 0.2, 0.1), 100);
                },
                error: () => {
                    AudioSys.playTone(150, 'sawtooth', 0.15, 0.2);
                    setTimeout(() => AudioSys.playTone(100, 'sawtooth', 0.3, 0.2), 150);
                }
            }
        };
    </script>

    <!-- ASSETS (SVGs) -->
    <script>
        const Assets = {
            ingredients: {
                'coffee': { color: '#3f2e27', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M2,21H20V19H2M20,8H18V5H20M20,3H4V13A4,4 0 0,0 8,17H14A4,4 0 0,0 18,13V10H20A2,2 0 0,0 22,8V5C22,3.89 21.1,3 20,3Z" /></svg>` },
                'milk': { color: '#f3f4f6', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 2h16l-2 4v16H6V6L4 2zm3 6v12h10V8H7z" /></svg>` },
                'sugar': { color: '#ffffff', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2v18h12V2H6zm6 12l-2-2 2-2 2 2-2 2z" /></svg>` },
                'slime_goo': { color: '#84cc16', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8 2 4 6 4 10v10h16V10c0-4-4-8-8-8z" /></svg>` },
                'ice': { color: '#a5f3fc', icon: `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4 6l8 4 8-4-8-4zm0 6l-8 4v8l8 4 8-4v-8l-8-4z" /></svg>` }
            },
            monsters: [
                // Skeleton
                `<svg class="w-full h-full text-gray-300 drop-shadow-lg" viewBox="0 0 100 100" fill="currentColor">
                    <rect x="35" y="20" width="30" height="25" rx="4" />
                    <rect x="40" y="28" width="8" height="8" fill="#111" />
                    <rect x="52" y="28" width="8" height="8" fill="#111" />
                    <path d="M42 40 L58 40" stroke="#111" stroke-width="2" />
                    <path d="M40 50 L60 50 M30 60 L70 60" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <rect x="45" y="50" width="10" height="20" />
                </svg>`,
                // Slime
                `<svg class="w-full h-full text-green-500 drop-shadow-lg" viewBox="0 0 100 100" fill="currentColor">
                    <path d="M20 85 Q10 85 10 65 Q10 25 50 25 Q90 25 90 65 Q90 85 80 85 Z" />
                    <circle cx="35" cy="50" r="6" fill="#000" />
                    <circle cx="65" cy="50" r="6" fill="#000" />
                    <path d="M40 65 Q50 70 60 65" stroke="#000" stroke-width="3" fill="none" />
                </svg>`,
                // Bat
                `<svg class="w-full h-full text-purple-500 drop-shadow-lg" viewBox="0 0 100 100" fill="currentColor">
                     <path d="M10 40 Q30 15 50 40 Q70 15 90 40 L80 75 L50 65 L20 75 Z" />
                     <circle cx="40" cy="45" r="4" fill="#fff" />
                     <circle cx="60" cy="45" r="4" fill="#fff" />
                     <path d="M45 55 L55 55" stroke="#fff" stroke-width="2" />
                </svg>`
            ]
        };
    </script>

    <!-- LOGIC -->
    <script>
        const Game = {
            state: {
                day: 1,
                gold: 0,
                lives: 3,
                deck: ['coffee', 'milk', 'sugar'],
                monsters: [],
                cauldron: [],
                isDragging: false,
                dragType: null,
                dragData: null,
                spawnRate: 4000
            },
            
            init: function() {
                AudioSys.init();
                document.getElementById('screen-start').classList.add('hidden');
                this.startDay();
                this.bindInput();
                this.loop();
            },

            startDay: function() {
                this.state.monsters = [];
                this.state.cauldron = [];
                document.getElementById('monster-row').innerHTML = '';
                this.updateUI();
                this.renderDeck();
                this.updateCauldron();
                this.lastSpawn = Date.now();
                this.gameActive = true;
                this.state.spawnRate = Math.max(1500, 4500 - (this.state.day * 300));
            },

            renderDeck: function() {
                const deckEl = document.getElementById('deck-zone');
                deckEl.innerHTML = '';
                this.state.deck.forEach(ingKey => {
                    const ing = Assets.ingredients[ingKey];
                    const card = document.createElement('div');
                    card.className = 'w-16 h-20 md:w-20 md:h-24 bg-[#262626] border-2 border-gray-600 rounded flex flex-col items-center justify-center shrink-0 active:scale-90 transition-transform relative select-none';
                    card.style.touchAction = 'none'; // Prevent scrolling while dragging
                    
                    card.innerHTML = `
                        <div class="w-8 h-8 text-gray-200 pointer-events-none mb-1">${ing.icon}</div>
                        <div class="text-[6px] md:text-[8px] uppercase font-bold text-gray-500 pointer-events-none">${ingKey}</div>
                    `;
                    
                    // Input Handlers
                    const startDrag = (e) => this.startDrag(e, 'ingredient', ingKey);
                    card.addEventListener('mousedown', startDrag);
                    card.addEventListener('touchstart', startDrag, {passive: false});
                    
                    deckEl.appendChild(card);
                });
            },

            spawnMonster: function() {
                if (this.state.monsters.length >= 3) return;

                const id = Date.now();
                const art = Assets.monsters[Math.floor(Math.random() * Assets.monsters.length)];
                
                // Recipe Logic
                const complexity = Math.min(3, 1 + Math.floor(this.state.day / 2));
                let recipe = ['coffee'];
                for(let i=1; i<complexity; i++) {
                    const extra = this.state.deck.filter(k => k !== 'coffee');
                    if(extra.length > 0) recipe.push(extra[Math.floor(Math.random() * extra.length)]);
                }
                recipe.sort();

                const monster = {
                    id: id,
                    art: art,
                    recipe: recipe,
                    patience: 100,
                    decay: 0.05 + (this.state.day * 0.01)
                };

                this.state.monsters.push(monster);
                this.renderMonster(monster);
            },

            renderMonster: function(m) {
                const el = document.createElement('div');
                el.id = `mon-${m.id}`;
                el.className = 'monster-bounce relative w-24 h-32 md:w-32 md:h-40 flex flex-col items-center justify-end pointer-events-auto transition-transform duration-200 z-10';
                
                // Bubble UI
                const bubble = document.createElement('div');
                bubble.className = 'bubble-tail absolute -top-8 bg-white border-2 border-black rounded px-2 py-1 flex gap-1 shadow-md z-20';
                m.recipe.forEach(r => {
                    const icon = document.createElement('div');
                    icon.className = 'w-4 h-4 text-black';
                    icon.innerHTML = Assets.ingredients[r].icon;
                    bubble.appendChild(icon);
                });

                el.innerHTML = `
                    <div class="w-full h-full p-2">${m.art}</div>
                    <div class="w-16 h-2 bg-black border border-gray-600 mt-1 overflow-hidden rounded-full">
                        <div id="bar-${m.id}" class="h-full bg-green-500 w-full transition-all duration-300"></div>
                    </div>
                `;
                el.prepend(bubble);
                document.getElementById('monster-row').appendChild(el);
            },

            update: function() {
                if(!this.gameActive) return;

                if (Date.now() - this.lastSpawn > this.state.spawnRate) {
                    this.spawnMonster();
                    this.lastSpawn = Date.now();
                }

                this.state.monsters.forEach((m) => {
                    m.patience -= m.decay;
                    const bar = document.getElementById(`bar-${m.id}`);
                    const el = document.getElementById(`mon-${m.id}`);
                    
                    if (bar && el) {
                        bar.style.width = `${m.patience}%`;
                        if (m.patience < 50) bar.className = 'h-full bg-yellow-500 w-full transition-all';
                        if (m.patience < 25) {
                            bar.className = 'h-full bg-red-600 w-full transition-all';
                            el.style.transform = `translateX(${Math.random()*4 - 2}px)`; // Shake
                        } else {
                            el.style.transform = 'none';
                        }
                    }

                    if (m.patience <= 0) this.removeMonster(m.id, false);
                });
            },

            removeMonster: function(id, success) {
                const idx = this.state.monsters.findIndex(m => m.id === id);
                if (idx === -1) return;
                
                const el = document.getElementById(`mon-${id}`);
                const rect = el.getBoundingClientRect();

                if (success) {
                    this.state.gold += 10;
                    this.showFloat(rect.left + 20, rect.top, "+$10", "text-yellow-400");
                    AudioSys.sfx.serve();
                } else {
                    this.state.lives--;
                    this.showFloat(rect.left + 20, rect.top, "MISS!", "text-red-500");
                    AudioSys.sfx.error();
                    document.body.classList.add('bg-red-900/50');
                    setTimeout(() => document.body.classList.remove('bg-red-900/50'), 100);
                }

                el.remove();
                this.state.monsters.splice(idx, 1);
                this.updateUI();

                if (this.state.lives <= 0) this.gameOver();
                if (this.state.gold >= 50 * this.state.day && this.state.monsters.length === 0) this.endDay();
            },

            updateUI: function() {
                const hearts = document.getElementById('hearts-container');
                hearts.innerHTML = '‚ù§Ô∏è'.repeat(Math.max(0, this.state.lives));
                document.getElementById('day-display').textContent = this.state.day;
                document.getElementById('gold-display').textContent = this.state.gold;
            },

            updateCauldron: function() {
                const stack = document.getElementById('cauldron-stack');
                stack.innerHTML = '';
                this.state.cauldron.forEach((ing, i) => {
                    const icon = document.createElement('div');
                    icon.innerHTML = Assets.ingredients[ing].icon;
                    icon.className = 'w-6 h-6 absolute text-white drop-shadow-md animate-bounce';
                    icon.style.left = `${50 + (i%2 ? -10 : 10)}%`;
                    icon.style.top = `${50 + (i * -5)}%`;
                    stack.appendChild(icon);
                });

                const liq = document.getElementById('cauldron-liquid');
                const count = this.state.cauldron.length;
                liq.style.height = `${Math.min(count * 20, 85)}%`;
                if(count > 0) {
                    const last = Assets.ingredients[this.state.cauldron[count-1]];
                    liq.style.backgroundColor = last.color;
                    document.getElementById('cauldron-bubbles').classList.remove('hidden');
                } else {
                    document.getElementById('cauldron-bubbles').classList.add('hidden');
                }
            },

            // --- DRAG SYSTEM ---
            startDrag: function(e, type, data) {
                if(!this.gameActive) return;
                e.preventDefault(); // Stop scroll
                
                this.state.isDragging = true;
                this.state.dragType = type;
                this.state.dragData = data;

                // Create Ghost
                const ghost = document.createElement('div');
                ghost.id = 'drag-ghost';
                ghost.className = 'ghost-item';
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;

                if(type === 'ingredient') {
                    ghost.innerHTML = `<div class="w-16 h-16 bg-[#262626] border-2 border-white rounded-full p-3 shadow-2xl flex items-center justify-center text-white">${Assets.ingredients[data].icon}</div>`;
                    AudioSys.sfx.pickup();
                } else {
                    // Cauldron Ghost
                    ghost.innerHTML = `<div class="text-6xl drop-shadow-2xl">üç≤</div>`;
                    document.getElementById('cauldron-zone').style.opacity = '0.3';
                    AudioSys.sfx.pickup();
                }

                ghost.style.left = `${clientX}px`;
                ghost.style.top = `${clientY}px`;
                document.body.appendChild(ghost);

                const move = (ev) => this.onDragMove(ev);
                const end = (ev) => {
                    this.onDragEnd(ev);
                    document.removeEventListener('mousemove', move);
                    document.removeEventListener('touchmove', move);
                    document.removeEventListener('mouseup', end);
                    document.removeEventListener('touchend', end);
                };

                document.addEventListener('mousemove', move);
                document.addEventListener('touchmove', move, {passive: false});
                document.addEventListener('mouseup', end);
                document.addEventListener('touchend', end);
            },

            onDragMove: function(e) {
                if(!this.state.isDragging) return;
                const ghost = document.getElementById('drag-ghost');
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                ghost.style.left = `${clientX}px`;
                ghost.style.top = `${clientY}px`;
            },

            onDragEnd: function(e) {
                this.state.isDragging = false;
                document.getElementById('drag-ghost')?.remove();
                document.getElementById('cauldron-zone').style.opacity = '1';

                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                const el = document.elementFromPoint(clientX, clientY);

                if(this.state.dragType === 'ingredient') {
                    if(el && el.closest('#cauldron-zone')) {
                        if(this.state.cauldron.length < 5) {
                            this.state.cauldron.push(this.state.dragData);
                            this.updateCauldron();
                            AudioSys.sfx.drop();
                        }
                    }
                } else if(this.state.dragType === 'cauldron') {
                    if(el.closest('#trash-zone')) {
                        this.state.cauldron = [];
                        this.updateCauldron();
                        AudioSys.sfx.trash();
                    } else {
                        const monster = el.closest('[id^="mon-"]');
                        if(monster) {
                            const id = parseInt(monster.id.split('-')[1]);
                            this.checkOrder(id);
                        }
                    }
                }
            },

            checkOrder: function(id) {
                const mon = this.state.monsters.find(m => m.id === id);
                if(!mon) return;

                const made = [...this.state.cauldron].sort().join('');
                const want = [...mon.recipe].sort().join('');

                if(made === want) {
                    this.removeMonster(id, true);
                    this.state.cauldron = [];
                    this.updateCauldron();
                } else {
                    AudioSys.sfx.error();
                    mon.patience -= 30;
                    this.showFloat(
                        document.getElementById(`mon-${id}`).getBoundingClientRect().left,
                        document.getElementById(`mon-${id}`).getBoundingClientRect().top,
                        "ERRADO!", "text-red-500"
                    );
                }
            },

            bindInput: function() {
                const c = document.getElementById('cauldron-zone');
                const start = (e) => { if(this.state.cauldron.length > 0) this.startDrag(e, 'cauldron', null); };
                c.addEventListener('mousedown', start);
                c.addEventListener('touchstart', start, {passive: false});

                document.getElementById('trash-zone').onclick = () => {
                    this.state.cauldron = [];
                    this.updateCauldron();
                    AudioSys.sfx.trash();
                };
            },

            showFloat: function(x, y, text, color) {
                const el = document.createElement('div');
                el.className = `float-text text-xl font-bold ${color}`;
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                el.textContent = text;
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 800);
            },

            loop: function() {
                requestAnimationFrame(() => this.loop());
                this.update();
            },

            endDay: function() {
                this.gameActive = false;
                document.getElementById('screen-shop').classList.remove('hidden');
                document.getElementById('screen-shop').classList.add('flex');
                document.getElementById('shop-gold').textContent = this.state.gold;
                this.renderShop();
            },

            renderShop: function() {
                const box = document.getElementById('shop-container');
                box.innerHTML = '';
                const items = [
                    {name: 'Gelo', type:'ing', id:'ice', cost:0, desc:'Serve bebidas geladas'},
                    {name: 'Slime', type:'ing', id:'slime_goo', cost:0, desc:'Gosma verde deliciosa'},
                    {name: 'Cura', type:'heal', cost:50, desc:'Recupera 1 Cora√ß√£o'}
                ];

                items.forEach(it => {
                    if(it.type === 'ing' && this.state.deck.includes(it.id)) return;
                    const btn = document.createElement('button');
                    btn.className = `w-full bg-[#262626] p-4 border-2 ${this.state.gold >= it.cost ? 'border-yellow-600' : 'border-gray-700 opacity-50'} flex justify-between items-center text-left`;
                    btn.innerHTML = `
                        <div>
                            <div class="text-[#fbbf24] text-xs font-bold">${it.name}</div>
                            <div class="text-[8px] text-gray-400">${it.desc}</div>
                        </div>
                        <div class="text-white font-bold">$${it.cost}</div>
                    `;
                    if(this.state.gold >= it.cost) {
                        btn.onclick = () => {
                            this.state.gold -= it.cost;
                            document.getElementById('shop-gold').textContent = this.state.gold;
                            if(it.type === 'ing') this.state.deck.push(it.id);
                            if(it.type === 'heal') this.state.lives++;
                            btn.remove();
                        };
                    }
                    box.appendChild(btn);
                });
            },

            closeShop: function() {
                document.getElementById('screen-shop').classList.remove('flex');
                document.getElementById('screen-shop').classList.add('hidden');
                this.state.day++;
                this.startDay();
            },

            gameOver: function() {
                this.gameActive = false;
                document.getElementById('screen-gameover').classList.remove('hidden');
                document.getElementById('screen-gameover').classList.add('flex');
                document.getElementById('final-score').textContent = this.state.day;
            }
        };
    </script>
</body>
</html>